<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Day 4: Moods & Melodies</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ffafcc 0%, #a2d2ff 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 40px 20px;
            overflow-y: auto;
        }
        
        .container {
            width: 100%;
            max-width: 900px;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(255, 175, 204, 0.3);
        }
        
        .header {
            background: linear-gradient(135deg, #ffafcc, #a2d2ff);
            color: white;
            padding: 30px 25px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .progress {
            margin-top: 15px;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .nav-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        
        .back-btn {
            padding: 10px 20px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .day-indicator {
            font-weight: 600;
            color: #ffafcc;
            font-size: 1.1rem;
        }
        
        .db-status {
            background: #e3f2fd;
            border: 2px solid #bbdefb;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 25px;
            color: #1565c0;
            font-weight: 600;
            text-align: center;
            display: none;
        }
        
        .db-status.success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .db-status.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        .progress-bar {
            height: 10px;
            background: #e0e0e0;
            margin-top: 15px;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #ffafcc, #a2d2ff);
            transition: width 0.5s ease;
        }
        
        .progress-dots {
            display: flex;
            justify-content: space-between;
            margin-top: -15px;
        }
        
        .dot {
            width: 40px;
            height: 40px;
            background: #e0e0e0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #666;
            z-index: 1;
        }
        
        .dot.active {
            background: #ffafcc;
            color: white;
            transform: scale(1.1);
        }
        
        .dot.completed {
            background: #a2d2ff;
            color: white;
        }
        
        .puzzle-content {
            padding: 40px;
            min-height: 600px;
        }
        
        .puzzle {
            display: none;
            animation: fadeIn 0.5s ease;
            padding: 20px 0;
        }
        
        .puzzle.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .puzzle h2 {
            color: #333;
            font-size: 1.8rem;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 30px 0;
        }
        
        .option {
            padding: 25px 20px;
            background: #f8f9fa;
            border: 3px solid #dee2e6;
            border-radius: 15px;
            font-size: 1.3rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #333;
            text-align: center;
        }
        
        .option:hover:not(:disabled) {
            border-color: #ffafcc;
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(255, 175, 204, 0.2);
        }
        
        .option.correct {
            background: #a2d2ff;
            color: white;
            border-color: #ffafcc;
        }
        
        .option.wrong {
            background: #ffafcc;
            color: white;
            border-color: #a2d2ff;
        }
        
        .option:disabled {
            cursor: not-allowed;
            opacity: 0.8;
        }
        
        .text-input {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin: 40px 0;
        }
        
        .text-input input {
            padding: 20px;
            border: 3px solid #dee2e6;
            border-radius: 12px;
            font-size: 1.3rem;
            width: 300px;
            text-align: center;
        }
        
        .text-input button {
            padding: 20px 40px;
            background: #ffafcc;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.3rem;
            cursor: pointer;
            font-weight: 600;
        }
        
        .text-input button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .lyrics-box {
            background: #fff0f5;
            border: 2px solid #ffafcc;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            font-style: italic;
            color: #333;
            line-height: 1.6;
            text-align: center;
        }
        
        .music-player-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            text-align: center;
        }
        
        .music-player-container h3 {
            color: #333;
            margin-bottom: 20px;
        }
        
        .song-message {
            background: #e3f2fd;
            border: 2px solid #bbdefb;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            color: #1565c0;
            font-weight: 600;
            text-align: center;
        }
        
        .player-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }
        
        .player-btn {
            padding: 15px 30px;
            background: #ffafcc;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            cursor: pointer;
            font-weight: 600;
        }
        
        .player-btn:hover:not(:disabled) {
            background: #a2d2ff;
            transform: scale(1.05);
        }
        
        .player-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .lyrics-container {
            max-height: 300px;
            overflow-y: auto;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            text-align: left;
            line-height: 1.8;
            display: none;
        }
        
        .lyrics-line {
            margin-bottom: 10px;
            padding: 5px;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }
        
        .lyrics-line.active {
            background-color: #fff0f5;
            font-weight: bold;
            color: #ff4081;
        }
        
        .audio-error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
        }
        
        .romantic-message-box {
            background: linear-gradient(135deg, #fff0f5, #f0f9ff);
            border: 3px solid #ffafcc;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            text-align: center;
            font-style: italic;
            color: #333;
            line-height: 1.8;
            font-size: 1.2rem;
        }
        
        .text-area {
            width: 100%;
            max-width: 600px;
            height: 150px;
            padding: 20px;
            border: 3px solid #dee2e6;
            border-radius: 12px;
            font-size: 1.1rem;
            font-family: inherit;
            resize: none;
            margin: 20px auto;
            display: block;
        }
        
        .text-area:focus {
            outline: none;
            border-color: #ffafcc;
        }
        
        .feedback {
            padding: 20px;
            margin: 25px auto;
            border-radius: 15px;
            font-size: 1.3rem;
            font-weight: 600;
            text-align: center;
            max-width: 600px;
            display: none;
        }
        
        .feedback.correct {
            background: #d4edda;
            color: #155724;
            border: 3px solid #c3e6cb;
        }
        
        .feedback.incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 3px solid #f5c6cb;
        }
        
        .special-message {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        
        .message-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: scaleIn 0.3s ease;
        }
        
        @keyframes scaleIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .message-box h3 {
            color: #ffafcc;
            font-size: 1.8rem;
            margin-bottom: 20px;
        }
        
        .message-box p {
            color: #333;
            font-size: 1.2rem;
            line-height: 1.6;
            margin-bottom: 30px;
        }
        
        .message-box button {
            padding: 15px 40px;
            background: #ffafcc;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
        }
        
        .hint-box {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            color: #856404;
            font-style: italic;
            text-align: center;
        }
        
        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 50px;
            padding: 30px 0;
            border-top: 2px solid #e9ecef;
        }
        
        .nav-btn {
            padding: 18px 35px;
            font-size: 1.2rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .prev-btn {
            background: #6c757d;
            color: white;
        }
        
        .next-btn {
            background: #ffafcc;
            color: white;
        }
        
        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .complete-btn {
            padding: 20px 50px;
            background: #a2d2ff;
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 1.4rem;
            font-weight: 600;
            cursor: pointer;
            display: none;
            margin: 30px auto;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(162, 210, 255, 0.4);
            }
            50% {
                box-shadow: 0 0 0 20px rgba(162, 210, 255, 0);
            }
        }
        
        .footer {
            text-align: center;
            padding: 25px;
            background: #f8f9fa;
            color: #666;
            border-top: 2px solid #e9ecef;
        }
        
        .hint {
            color: #888;
            font-style: italic;
            text-align: center;
            margin: 15px 0;
            font-size: 1.1rem;
        }
        
        .save-status {
            text-align: center;
            color: #28a745;
            font-weight: 600;
            margin: 20px 0;
            font-size: 1.1rem;
            min-height: 24px;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
            flex-direction: column;
            gap: 20px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #ffebee;
            border-top: 5px solid #ffafcc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        
        .read-only-mode .option,
        .read-only-mode input,
        .read-only-mode textarea,
        .read-only-mode button:not(.back-btn):not(.nav-btn):not(.player-btn):not(.play-btn) {
            opacity: 0.8;
            cursor: default !important;
        }
        
        .read-only-mode .option:hover {
            transform: none !important;
            box-shadow: none !important;
            border-color: #dee2e6 !important;
        }
        
        .read-only-mode .container {
            border: 3px solid #a2d2ff;
        }
        
        .completed-badge {
            background: #a2d2ff;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .completed-message {
            background: #d4edda;
            color: #155724;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            font-weight: 600;
            border: 2px solid #c3e6cb;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            .header {
                padding: 20px 15px;
            }
            .header h1 {
                font-size: 1.8rem;
            }
            .puzzle-content {
                padding: 20px;
            }
            .options {
                grid-template-columns: 1fr;
            }
            .option {
                padding: 20px 15px;
                font-size: 1.1rem;
            }
            .player-controls {
                flex-direction: column;
                align-items: center;
            }
            .player-btn {
                width: 100%;
                max-width: 250px;
            }
            .navigation {
                flex-direction: column;
                gap: 10px;
            }
            .nav-btn {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Database Status -->
        <div id="dbStatus" class="db-status">üîÑ Checking access...</div>

        <!-- Loading State -->
        <div id="loadingDay" class="loading">
            <div class="spinner"></div>
            <p>Loading Day 4...</p>
        </div>

        <!-- Main Content (hidden initially) -->
        <div id="dayContent" style="display: none;">
            <!-- Header -->
            <div class="header">
                <h1 id="dayTitle">Day 4: Moods & Melodies</h1>
                <div class="progress">Question <span id="currentPuzzle">1</span>/5</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-dots">
                    <div class="dot active">1</div>
                    <div class="dot">2</div>
                    <div class="dot">3</div>
                    <div class="dot">4</div>
                    <div class="dot">5</div>
                </div>
            </div>

            <!-- Navigation Bar -->
            <div class="nav-bar">
                <a href="dashboard.html" class="back-btn">‚Üê Back to Dashboard</a>
                <div id="dayIndicator" class="day-indicator">Day 4 of 7</div>
            </div>

            <!-- Puzzle Content -->
            <div class="puzzle-content">
                <!-- Completed Message (only shown in read-only mode) -->
                <div id="completedMessage" class="completed-message" style="display: none;">
                    You've already completed this day! Viewing in read-only mode. Proud of you! üíñ
                </div>

                <!-- Puzzle 1 -->
                <div id="puzzle1" class="puzzle active">
                    <h2>Guess my current mood ü´†</h2>
                    <div class="hint-box">
                        üí° Hint: I'm feeling playful and romantic
                    </div>
                    <div class="options">
                        <button class="option" data-answer="Chill">Chill üçÉ</button>
                        <button class="option" data-answer="Silly">Silly üòú</button>
                        <button class="option" data-answer="Hungry">Hungry üçï</button>
                        <button class="option" data-answer="In love">In love üíï</button>
                    </div>
                    <div id="feedback1" class="feedback"></div>
                </div>

                <!-- Puzzle 2 -->
                <div id="puzzle2" class="puzzle">
                    <h2>Finish the lyric üôÇ‚Äç‚ÜïÔ∏è</h2>
                    <div class="hint-box">
                        üí° I know you'll get this ü•π
                    </div>
                    <div class="lyrics-box">
                        "Fall in love with you, you _____"
                    </div>
                    <div class="text-input">
                        <input type="text" id="lyricInput" placeholder="Complete the lyric" maxlength="20">
                        <button id="checkLyric">Submit</button>
                    </div>
                    <div id="feedback2" class="feedback"></div>
                </div>

                <!-- Puzzle 3 -->
                <div id="puzzle3" class="puzzle">
                    <h2>Mini Riddle ü´†</h2>
                    <div class="hint-box">
                        üí° Think of something that keeps us connected (for now) ü•≤
                    </div>
                    <h3 style="text-align: center; margin: 30px 0; color: #333;">"I'm not a blanket, but I keep you warm... what am I?"</h3>
                    <div class="text-input">
                        <input type="text" id="riddleAnswer" placeholder="Your answer" maxlength="20">
                        <button id="checkRiddle">Submit Answer</button>
                    </div>
                    <div id="feedback3" class="feedback"></div>
                </div>

                <!-- Puzzle 4 -->
                <div id="puzzle4" class="puzzle">
                    <h2>Special Song for You üéµ</h2>
                    <div class="hint-box">
                        Just enjoy
                    </div>
                    <div class="music-player-container">
                        <div class="song-message">
                            üíå If you can record a short video and send it to me singing this song
                        </div>
                        <div class="player-controls">
                            <button id="playBtn" class="player-btn">‚ñ∂ Play Song</button>
                            <button id="pauseBtn" class="player-btn" style="background: #a2d2ff;" disabled>‚è∏ Pause</button>
                        </div>
                        <div class="audio-error" id="audioError"></div>
                        <div id="lyricsContainer" class="lyrics-container">
                            <!-- Lyrics will be inserted here by JavaScript -->
                        </div>
                    </div>
                    <div id="feedback4" class="feedback"></div>
                </div>

                <!-- Puzzle 5 -->
                <div id="puzzle5" class="puzzle">
                    <h2>A Message ‚ù§Ô∏è</h2>
                    <div class="hint-box">
                        üí° Write a message for me (max 30 words)
                    </div>
                    <div class="romantic-message-box">
                        <textarea class="text-area" id="romanticMessage" placeholder="Write your romantic message here..." maxlength="200"></textarea>
                        <button id="saveMessage" class="player-btn" style="margin-top: 20px; background: #ffafcc;">Save Message</button>
                    </div>
                    <div id="feedback5" class="feedback"></div>
                </div>

                <!-- Navigation -->
                <div class="navigation">
                    <button id="prevBtn" class="nav-btn prev-btn" disabled>‚Üê Previous</button>
                    <button id="nextBtn" class="nav-btn next-btn">Next Question ‚Üí</button>
                </div>

                <!-- Save Status -->
                <div id="saveStatus" class="save-status"></div>

                <!-- Complete Button -->
                <button id="completeBtn" class="complete-btn">Complete Day 4, approaching victoryü•≥ </button>
            </div>

            <!-- Footer -->
            <div class="footer">
                <p>Made by Hlakulo (Your Emotional Supporter)</p>
            </div>
        </div>
    </div>

    <!-- Special Message Popup -->
    <div id="specialMessage" class="special-message">
        <div class="message-box">
            <h3 id="messageTitle">Special Message! üíï</h3>
            <p id="messageText"></p>
            <button id="closeMessage">Continue</button>
        </div>
    </div>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://yqxrsigblsalvhndfvvs.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlxeHJzaWdibHNhbHZobmRmdnZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNDUwNjQsImV4cCI6MjA4MDYyMTA2NH0.gsj4ya1LMKNtWGdwhaDa91L81AdOc6E1BcBd2gwXcJc';

        // Global variables
        let supabase;
        let currentUser = null;
        let currentDay = 4;
        let isReadOnly = false;
        let audio = null;
        let lyrics = [];

        // Lyrics for Puzzle 4
        const SONG_LYRICS = [
            "I could be the twist, the one to make you stop",
            "The icing on your cake, the cherry on the top",
            "It's heaven in my heart, and we could find you some space, mm",
            "I could be the world to you, the missing piece",
            "That extra sentimental kind of chemistry",
            "Some people make it hard, with me, that isn't the case",
            "'Cause I make it so easy to fall in love",
            "So come give me a call, and we'll fall into us",
            "I'm the perfect mix of Saturday night and the rest of your life",
            "Anyone with a heart would agree",
            "It's so easy to fall in love with",
            "The way I do my hair, the way I make you laugh",
            "The way we like to share, a walk in Central Park",
            "I could be fresh air, might be the girl of your dreams (dream, dream, dream, dream)",
            "There's no need to hide if you're into me",
            "'Cause I'm into you quite intimately",
            "And maybe one night could turn into three",
            "Well, I'm down to see",
            "'Cause I make it so easy to fall in love",
            "So come give me a call, and we'll fall into us",
            "I'm the perfect mix of Saturday night and the rest of your life",
            "Anyone with a heart would agree",
            "It's so easy to fall in love with me (me, me)",
            "It's so easy",
            "It's so easy",
            "It's so easy",
            "Hey, yeah, hey",
            "It's so easy to fall in love",
            "So come give me a call, and we'll fall into us",
            "I'm the perfect mix of Saturday night and the rest of your life",
            "Anyone with a heart would agree",
            "It's so easy to fall in love with me"
        ];

        // Correct answers
        const CORRECT_ANSWERS = {
            1: ['Silly', 'In love'], // Multiple correct answers
            2: 'my love',
            3: ['texts', 'calls'], // Multiple correct answers
            4: '', // No wrong answer
            5: '' // No wrong answer
        };

        // Main initialization - SESSIONSTORAGE ONLY
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Day 4: DOM loaded');

            // SIMPLE AUTHENTICATION CHECK - SESSIONSTORAGE ONLY
            await checkAuthentication();
        });

        // SIMPLIFIED AUTHENTICATION CHECK - SESSIONSTORAGE ONLY
        async function checkAuthentication() {
            console.log('Checking authentication...');

            // Check sessionStorage ONLY (will auto-clear when tab closes)
            const sessionData = sessionStorage.getItem('currentUser');

            if (sessionData) {
                try {
                    currentUser = JSON.parse(sessionData);
                    console.log('Found user in sessionStorage:', currentUser.username);

                    console.log('Authentication successful! User:', currentUser.username);

                    // Initialize Supabase
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

                    // Now check Day 4 access
                    await initializeDay();

                } catch (error) {
                    console.error('Error parsing sessionStorage:', error);
                    redirectToLogin();
                }
            } else {
                // No user found
                console.log('NO USER FOUND - Redirecting to login');
                redirectToLogin();
            }
        }

        function redirectToLogin() {
            showDBStatus('‚ùå Please login first!', 'error');
            setTimeout(() => {
                // Clear session data
                sessionStorage.clear();
                window.location.href = 'index.html';
            }, 1500);
        }

        async function initializeDay() {
            console.log('Initializing Day 4 for user:', currentUser.username);
            showDBStatus('üîê Checking Day 4 access...');

            try {
                // Check if Day 4 progress exists
                const {
                    data: progress,
                    error
                } = await supabase
                    .from('user_progress')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .eq('day_number', currentDay)
                    .single();

                if (error) {
                    // If no progress found, check if Day 3 is completed
                    if (error.code === 'PGRST116') {
                        console.log('No Day 4 progress found, checking Day 3 completion...');

                        const {
                            data: day3Progress
                        } = await supabase
                            .from('user_progress')
                            .select('completed')
                            .eq('user_id', currentUser.id)
                            .eq('day_number', 3)
                            .single();

                        if (!day3Progress || !day3Progress.completed) {
                            showDBStatus('‚ùå Complete Day 3 first!', 'error');
                            setTimeout(() => {
                                window.location.href = 'dashboard.html';
                            }, 2000);
                            return;
                        }

                        // Create Day 4 progress
                        await createDayProgress();
                    } else {
                        console.error('Error checking progress:', error);
                        throw error;
                    }
                } else {
                    console.log('Day 4 progress found:', progress);

                    if (!progress.unlocked_at && !progress.completed) {
                        showDBStatus('‚ùå Day 4 is locked', 'error');
                        setTimeout(() => {
                            window.location.href = 'dashboard.html';
                        }, 1500);
                        return;
                    }

                    if (progress.completed) {
                        console.log('Day 4 is completed - read-only mode');
                        isReadOnly = true;
                    }
                }

                console.log('Access granted! Read-only:', isReadOnly);
                showDBStatus('‚úÖ Access granted!', 'success');

                // Show content
                setTimeout(() => {
                    hideDBStatus();
                    document.getElementById('loadingDay').style.display = 'none';
                    document.getElementById('dayContent').style.display = 'block';
                    initializeQuiz();
                }, 1000);

            } catch (error) {
                console.error('Error initializing day:', error);
                showDBStatus('‚ùå Error: ' + error.message, 'error');
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 2000);
            }
        }

        async function createDayProgress() {
            const {
                error
            } = await supabase
                .from('user_progress')
                .insert([{
                    user_id: currentUser.id,
                    day_number: currentDay,
                    unlocked_at: new Date().toISOString(),
                    next_unlock_at: null,
                    completed: false,
                    progress: 0,
                    score: 0,
                    answers: {}
                }]);

            if (error) throw error;
        }

        function initializeQuiz() {
            console.log('Initializing Day 4 quiz...');

            // Create audio element
            createAudioElement();

            // Quiz state
            let currentPuzzle = 1;
            const totalPuzzles = 5;
            const completedPuzzles = new Array(totalPuzzles).fill(false);
            let consecutiveCorrect = 0; // Keep track internally but don't show
            let wrongAttempts = {};

            // DOM Elements
            const currentPuzzleSpan = document.getElementById('currentPuzzle');
            const progressFill = document.getElementById('progressFill');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const completeBtn = document.getElementById('completeBtn');
            const dots = document.querySelectorAll('.dot');
            const specialMessage = document.getElementById('specialMessage');
            const messageText = document.getElementById('messageText');
            const messageTitle = document.getElementById('messageTitle');
            const closeMessage = document.getElementById('closeMessage');
            const completedMessage = document.getElementById('completedMessage');
            const lyricsContainer = document.getElementById('lyricsContainer');

            // Set up read-only mode if day is completed
            if (isReadOnly) {
                setupReadOnlyMode();
            }

            // Function to show specific puzzle
            function showPuzzle(num) {
                console.log('Showing puzzle', num);

                // Hide all puzzles
                for (let i = 1; i <= totalPuzzles; i++) {
                    const puzzle = document.getElementById(`puzzle${i}`);
                    if (puzzle) {
                        puzzle.classList.remove('active');
                    }
                }

                // Show current puzzle
                const currentPuzzleElement = document.getElementById(`puzzle${num}`);
                if (currentPuzzleElement) {
                    currentPuzzleElement.classList.add('active');
                    currentPuzzle = num;
                }

                // If showing puzzle 4, load lyrics
                if (num === 4 && lyricsContainer) {
                    loadLyrics();
                }

                // Update UI
                updateProgress();
                updateNavigation();
            }

            // Update progress display
            function updateProgress() {
                if (currentPuzzleSpan) currentPuzzleSpan.textContent = currentPuzzle;

                // Calculate progress percentage
                const completedCount = completedPuzzles.filter(c => c).length;
                const progressPercent = ((completedCount + (currentPuzzle - 1)) / totalPuzzles) * 100;
                if (progressFill) progressFill.style.width = `${progressPercent}%`;

                // Update dots
                dots.forEach((dot, index) => {
                    const puzzleNum = index + 1;
                    dot.classList.remove('active', 'completed');

                    if (puzzleNum === currentPuzzle) {
                        dot.classList.add('active');
                    } else if (completedPuzzles[puzzleNum - 1]) {
                        dot.classList.add('completed');
                    }
                });

                // Show/hide complete button
                const allCompleted = completedPuzzles.every(c => c);
                if (completeBtn && !isReadOnly) {
                    if (allCompleted) {
                        completeBtn.style.display = 'block';
                    } else {
                        completeBtn.style.display = 'none';
                    }
                }
            }

            // Update navigation buttons
            function updateNavigation() {
                if (prevBtn) prevBtn.disabled = currentPuzzle === 1;
                if (nextBtn) nextBtn.disabled = currentPuzzle === totalPuzzles;
            }

            // Setup all event listeners
            function setupEventListeners() {
                console.log('Setting up event listeners...');

                // Previous/Next buttons
                if (prevBtn) {
                    prevBtn.addEventListener('click', function() {
                        if (currentPuzzle > 1) {
                            showPuzzle(currentPuzzle - 1);
                        }
                    });
                }

                if (nextBtn) {
                    nextBtn.addEventListener('click', function() {
                        if (currentPuzzle < totalPuzzles) {
                            showPuzzle(currentPuzzle + 1);
                        }
                    });
                }

                // Complete button (only in active mode)
                if (completeBtn && !isReadOnly) {
                    completeBtn.addEventListener('click', function() {
                        showSpecialMessage("Every day with you feels like a beautiful song üé∂", true);
                    });
                }

                // Close message button
                if (closeMessage) {
                    closeMessage.addEventListener('click', function() {
                        specialMessage.style.display = 'none';

                        // If day is complete, redirect to dashboard
                        if (completedPuzzles.every(c => c) && !isReadOnly) {
                            completeDay();
                        }
                    });
                }

                // Load saved answers first
                loadSavedAnswers().then(savedAnswers => {
                    console.log('Loaded saved answers:', savedAnswers);
                    if (savedAnswers && savedAnswers.length > 0) {
                        restoreProgress(savedAnswers);
                        // Force update the progress display
                        updateProgress();
                    }

                    // Now setup each puzzle (only if not read-only)
                    if (!isReadOnly) {
                        setupPuzzle1();
                        setupPuzzle2();
                        setupPuzzle3();
                        setupPuzzle4();
                        setupPuzzle5();
                    } else {
                        // In read-only mode, still allow audio to play
                        setupAudioForReadOnly();
                    }
                });
            }

            // Create audio element dynamically
            function createAudioElement() {
                audio = new Audio();
                audio.preload = 'auto';

                // Add multiple source formats for compatibility
                const sources = [{
                    src: 'assets/songs/day4-song.mp3',
                    type: 'audio/mpeg'
                }, {
                    src: 'assets/songs/day4-song.m4a',
                    type: 'audio/mp4'
                }, {
                    src: 'assets/songs/day4-song.ogg',
                    type: 'audio/ogg'
                }, {
                    src: 'assets/songs/day4-song.wav',
                    type: 'audio/wav'
                }];

                sources.forEach(source => {
                    const sourceElement = document.createElement('source');
                    sourceElement.src = source.src;
                    sourceElement.type = source.type;
                    audio.appendChild(sourceElement);
                });

                // Add error event listener
                audio.addEventListener('error', function(e) {
                    console.error('Audio error:', e);
                    const errorMsg = document.getElementById('audioError');
                    if (errorMsg) {
                        errorMsg.textContent = "‚ö†Ô∏è Could not load audio file. Please check if assets/songs/day4-song.mp3 exists.";
                        errorMsg.style.display = 'block';
                    }
                });

                audio.addEventListener('canplaythrough', function() {
                    console.log('Audio is ready to play');
                    const playBtn = document.getElementById('playBtn');
                    if (playBtn) {
                        playBtn.disabled = false;
                    }
                });

                // Update lyrics highlighting based on current time
                audio.addEventListener('timeupdate', updateLyricsHighlight);

                // Handle audio end
                audio.addEventListener('ended', function() {
                    const playBtn = document.getElementById('playBtn');
                    const pauseBtn = document.getElementById('pauseBtn');
                    if (playBtn) playBtn.textContent = "‚ñ∂ Play Song";
                    if (pauseBtn) pauseBtn.disabled = true;
                });

                // Add to document
                document.body.appendChild(audio);
            }

            // Load lyrics into container
            function loadLyrics() {
                const lyricsContainer = document.getElementById('lyricsContainer');
                if (!lyricsContainer) return;

                lyricsContainer.innerHTML = '';
                lyrics = [];

                SONG_LYRICS.forEach((line, index) => {
                    const lineElement = document.createElement('div');
                    lineElement.className = 'lyrics-line';
                    lineElement.textContent = line;
                    lineElement.dataset.index = index;
                    lyricsContainer.appendChild(lineElement);
                    lyrics.push(lineElement);
                });

                lyricsContainer.style.display = 'block';
            }

            // Update lyrics highlighting based on current time
            function updateLyricsHighlight() {
                if (!audio || !lyrics.length) return;

                const currentTime = audio.currentTime;
                const duration = audio.duration || 180; // Default 3 minutes if duration not available
                const progress = currentTime / duration;
                const lineIndex = Math.floor(progress * lyrics.length);

                // Remove active class from all lines
                lyrics.forEach(line => line.classList.remove('active'));

                // Add active class to current line
                if (lyrics[lineIndex]) {
                    lyrics[lineIndex].classList.add('active');

                    // Scroll to active line
                    lyrics[lineIndex].scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                }
            }

            // Setup Puzzle 1 (Mood guess)
            function setupPuzzle1() {
                const options = document.querySelectorAll('#puzzle1 .option');

                if (!options.length) {
                    console.error('Puzzle 1 elements not found');
                    return;
                }

                // Initialize wrong attempts counter
                if (!wrongAttempts[1]) {
                    wrongAttempts[1] = 0;
                }

                options.forEach(option => {
                    option.addEventListener('click', async function() {
                        const userAnswer = this.dataset.answer;
                        const isCorrect = CORRECT_ANSWERS[1].includes(userAnswer);

                        if (isCorrect) {
                            // Correct answer
                            this.classList.add('correct');
                            completedPuzzles[0] = true;
                            options.forEach(opt => opt.disabled = true);

                            // Update consecutive counter (internally only)
                            consecutiveCorrect++;

                            // Save answer to Supabase
                            await saveAnswerToSupabase(1, {
                                answer: userAnswer,
                                correct: true,
                                attempts: 1
                            });

                            // Update progress
                            updateProgress();
                            showFeedback(1, true, 1);
                        } else {
                            // Wrong answer
                            this.classList.add('wrong');
                            this.disabled = true;

                            // Reset consecutive counter
                            consecutiveCorrect = 0;

                            // Track wrong attempts
                            wrongAttempts[1] = (wrongAttempts[1] || 0) + 1;

                            // Show hint after 2 wrong attempts
                            if (wrongAttempts[1] === 2) {
                                showHint(1);
                            }

                            // Save attempt to Supabase
                            await saveAnswerToSupabase(1, {
                                answer: userAnswer,
                                correct: false,
                                attempts: 1
                            });

                            showFeedback(1, false, wrongAttempts[1]);
                        }
                    });
                });
            }

            // Setup Puzzle 2 (Lyric completion)
            function setupPuzzle2() {
                const lyricInput = document.getElementById('lyricInput');
                const checkLyric = document.getElementById('checkLyric');

                if (!lyricInput || !checkLyric) {
                    console.error('Puzzle 2 elements not found');
                    return;
                }

                // Initialize wrong attempts counter
                if (!wrongAttempts[2]) {
                    wrongAttempts[2] = 0;
                }

                checkLyric.addEventListener('click', async function() {
                    const userAnswer = lyricInput.value.trim().toLowerCase();
                    if (!userAnswer) {
                        showFeedback(2, false, 0);
                        return;
                    }

                    const correctAnswer = CORRECT_ANSWERS[2].toLowerCase();
                    const isCorrect = userAnswer === correctAnswer;

                    if (isCorrect) {
                        // Correct answer
                        lyricInput.classList.add('correct');
                        lyricInput.disabled = true;
                        checkLyric.disabled = true;
                        completedPuzzles[1] = true;

                        // Update consecutive counter (internally only)
                        consecutiveCorrect++;

                        // Save answer to Supabase
                        await saveAnswerToSupabase(2, {
                            answer: userAnswer,
                            correct: true,
                            attempts: 1
                        });

                        // Update progress
                        updateProgress();
                        showFeedback(2, true, 1);
                    } else {
                        // Wrong answer
                        lyricInput.classList.add('wrong');

                        // Reset consecutive counter
                        consecutiveCorrect = 0;

                        // Track wrong attempts
                        wrongAttempts[2] = (wrongAttempts[2] || 0) + 1;

                        // Show hint after 2 wrong attempts
                        if (wrongAttempts[2] === 2) {
                            showHint(2);
                        }

                        // Save attempt to Supabase
                        await saveAnswerToSupabase(2, {
                            answer: userAnswer,
                            correct: false,
                            attempts: 1
                        });

                        // Clear input after delay
                        setTimeout(() => {
                            lyricInput.classList.remove('wrong');
                            lyricInput.value = '';
                        }, 1000);

                        showFeedback(2, false, wrongAttempts[2]);
                    }
                });

                // Enter key support
                lyricInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        checkLyric.click();
                    }
                });
            }

            // Setup Puzzle 3 (Riddle)
            function setupPuzzle3() {
                const riddleAnswer = document.getElementById('riddleAnswer');
                const checkRiddle = document.getElementById('checkRiddle');

                if (!riddleAnswer || !checkRiddle) {
                    console.error('Puzzle 3 elements not found');
                    return;
                }

                // Initialize wrong attempts counter
                if (!wrongAttempts[3]) {
                    wrongAttempts[3] = 0;
                }

                checkRiddle.addEventListener('click', async function() {
                    const userAnswer = riddleAnswer.value.trim().toLowerCase();
                    if (!userAnswer) {
                        showFeedback(3, false, 0);
                        return;
                    }

                    const correctAnswers = CORRECT_ANSWERS[3].map(a => a.toLowerCase());
                    const isCorrect = correctAnswers.includes(userAnswer);

                    if (isCorrect) {
                        // Correct answer
                        riddleAnswer.classList.add('correct');
                        riddleAnswer.disabled = true;
                        checkRiddle.disabled = true;
                        completedPuzzles[2] = true;

                        // Update consecutive counter (internally only)
                        consecutiveCorrect++;

                        // Save answer to Supabase
                        await saveAnswerToSupabase(3, {
                            answer: userAnswer,
                            correct: true,
                            attempts: 1
                        });

                        // Update progress
                        updateProgress();
                        showFeedback(3, true, 1);
                    } else {
                        // Wrong answer
                        riddleAnswer.classList.add('wrong');

                        // Reset consecutive counter
                        consecutiveCorrect = 0;

                        // Track wrong attempts
                        wrongAttempts[3] = (wrongAttempts[3] || 0) + 1;

                        // Show hint after 2 wrong attempts
                        if (wrongAttempts[3] === 2) {
                            showHint(3);
                        }

                        // Save attempt to Supabase
                        await saveAnswerToSupabase(3, {
                            answer: userAnswer,
                            correct: false,
                            attempts: 1
                        });

                        // Clear input after delay
                        setTimeout(() => {
                            riddleAnswer.classList.remove('wrong');
                            riddleAnswer.value = '';
                        }, 1000);

                        showFeedback(3, false, wrongAttempts[3]);
                    }
                });

                // Enter key support
                riddleAnswer.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        checkRiddle.click();
                    }
                });
            }

            // Setup Puzzle 4 (Music player)
            function setupPuzzle4() {
                const playBtn = document.getElementById('playBtn');
                const pauseBtn = document.getElementById('pauseBtn');
                const audioError = document.getElementById('audioError');

                if (!playBtn || !pauseBtn) {
                    console.error('Puzzle 4 elements not found');
                    return;
                }

                // Load lyrics
                loadLyrics();

                // Play button
                playBtn.addEventListener('click', async function() {
                    try {
                        // Reset audio if at the end
                        if (audio.ended) {
                            audio.currentTime = 0;
                        }

                        // Show loading state
                        playBtn.disabled = true;
                        playBtn.textContent = "Loading...";
                        if (audioError) audioError.style.display = 'none';

                        // Play audio
                        await audio.play();

                        // Update UI
                        playBtn.textContent = "Playing...";
                        playBtn.disabled = true;
                        pauseBtn.disabled = false;

                        // Show lyrics container if hidden
                        const lyricsContainer = document.getElementById('lyricsContainer');
                        if (lyricsContainer) {
                            lyricsContainer.style.display = 'block';
                        }

                        // Mark puzzle as completed when song starts playing
                        if (!completedPuzzles[3]) {
                            completedPuzzles[3] = true;
                            await saveAnswerToSupabase(4, {
                                answer: 'Song played',
                                correct: true,
                                attempts: 1
                            });
                            updateProgress();
                        }

                    } catch (error) {
                        console.error('Error playing audio:', error);
                        showSaveStatus("‚ùå Couldn't play audio. Check browser permissions and file path.", 'error');
                        if (audioError) {
                            audioError.textContent = "Error playing audio. Make sure assets/songs/day4-song.mp3 exists.";
                            audioError.style.display = 'block';
                        }
                        playBtn.disabled = false;
                        playBtn.textContent = "‚ñ∂ Play Song";
                    }
                });

                // Pause button
                pauseBtn.addEventListener('click', function() {
                    if (!audio.paused) {
                        audio.pause();
                        playBtn.disabled = false;
                        playBtn.textContent = "‚ñ∂ Play Song";
                        pauseBtn.disabled = true;

                        // Hide lyrics when paused
                        const lyricsContainer = document.getElementById('lyricsContainer');
                        if (lyricsContainer) {
                            lyricsContainer.style.display = 'none';
                        }
                    }
                });
            }

            // Setup audio for read-only mode
            function setupAudioForReadOnly() {
                const playBtn = document.getElementById('playBtn');
                const pauseBtn = document.getElementById('pauseBtn');
                const audioError = document.getElementById('audioError');

                if (!playBtn || !pauseBtn) return;

                // Load lyrics
                loadLyrics();

                // Play button
                playBtn.addEventListener('click', async function() {
                    try {
                        // Reset audio if at the end
                        if (audio.ended) {
                            audio.currentTime = 0;
                        }

                        // Show loading state
                        playBtn.disabled = true;
                        playBtn.textContent = "Loading...";
                        if (audioError) audioError.style.display = 'none';

                        // Play audio
                        await audio.play();

                        // Update UI
                        playBtn.textContent = "Playing...";
                        playBtn.disabled = true;
                        pauseBtn.disabled = false;

                        // Show lyrics container
                        const lyricsContainer = document.getElementById('lyricsContainer');
                        if (lyricsContainer) {
                            lyricsContainer.style.display = 'block';
                        }

                    } catch (error) {
                        console.error('Error playing audio:', error);
                        showSaveStatus("‚ùå Couldn't play audio. Check browser permissions and file path.", 'error');
                        if (audioError) {
                            audioError.textContent = "Error playing audio. Make sure assets/songs/day4-song.mp3 exists.";
                            audioError.style.display = 'block';
                        }
                        playBtn.disabled = false;
                        playBtn.textContent = "‚ñ∂ Play Song";
                    }
                });

                // Pause button
                pauseBtn.addEventListener('click', function() {
                    if (!audio.paused) {
                        audio.pause();
                        playBtn.disabled = false;
                        playBtn.textContent = "‚ñ∂ Play Song";
                        pauseBtn.disabled = true;

                        // Hide lyrics when paused
                        const lyricsContainer = document.getElementById('lyricsContainer');
                        if (lyricsContainer) {
                            lyricsContainer.style.display = 'none';
                        }
                    }
                });
            }

            // Setup Puzzle 5 (Romantic message)
            function setupPuzzle5() {
                const romanticMessage = document.getElementById('romanticMessage');
                const saveMessage = document.getElementById('saveMessage');

                if (!romanticMessage || !saveMessage) {
                    console.error('Puzzle 5 elements not found');
                    return;
                }

                saveMessage.addEventListener('click', async function() {
                    const userAnswer = romanticMessage.value.trim();
                    if (!userAnswer) {
                        showFeedback(5, false, 0);
                        return;
                    }

                    // Mark as completed (must have input)
                    romanticMessage.disabled = true;
                    saveMessage.disabled = true;
                    completedPuzzles[4] = true;

                    // Save answer to Supabase
                    await saveAnswerToSupabase(5, {
                        answer: userAnswer,
                        correct: true, // Always correct for this question
                        attempts: 1
                    });

                    // Update progress
                    updateProgress();
                    showFeedback(5, true, 1);
                });
            }

            // Show feedback message
            function showFeedback(puzzleNum, isCorrect, attempt) {
                const feedbackElement = document.getElementById(`feedback${puzzleNum}`);
                if (!feedbackElement) return;

                if (isCorrect && !isReadOnly) {
                    feedbackElement.textContent = "Good"; // Changed from "‚úÖ Correct! Well done!"
                    feedbackElement.className = 'feedback correct';
                    feedbackElement.style.display = 'block';

                    // Auto-hide after 2 seconds for active mode
                    setTimeout(() => {
                        feedbackElement.style.display = 'none';
                    }, 2000);
                } else if (!isCorrect && !isReadOnly) {
                    let message;
                    if (attempt === 1) {
                        message = "Hawa ü´†";
                    } else if (attempt === 2) {
                        message = "Please think üò§";
                    } else {
                        message = "Use that one brain cell sweetheart ü•π ";
                    }

                    feedbackElement.textContent = message;
                    feedbackElement.className = 'feedback incorrect';
                    feedbackElement.style.display = 'block';

                    // Auto-hide after 3 seconds
                    setTimeout(() => {
                        feedbackElement.style.display = 'none';
                    }, 3000);
                }
                // In read-only mode, don't show any feedback messages
            }

            // Show special message popup
            function showSpecialMessage(message, isDayComplete = false) {
                if (!messageText || !messageTitle) return;

                messageText.textContent = message;
                messageTitle.textContent = isDayComplete ? "Day 4 Complete! " : "Special Message! üíï";
                if (specialMessage) {
                    specialMessage.style.display = 'flex';
                }

                // If day is complete, update button text
                if (isDayComplete && closeMessage) {
                    closeMessage.textContent = "Go to Dashboard";
                }
            }

            // Show hint after 2 wrong attempts
            function showHint(puzzleNum) {
                const hints = {
                    1: "Hint: I'm feeling both playful and romantic",
                    2: "Hint: It's two words that show affection",
                    3: "Hint: Think about what keeps us connected since we are apart",
                };

                const hint = hints[puzzleNum];
                if (hint) {
                    const feedbackElement = document.getElementById(`feedback${puzzleNum}`);
                    if (feedbackElement && !isReadOnly) {
                        feedbackElement.textContent = `üí° ${hint}`;
                        feedbackElement.className = 'feedback incorrect';
                        feedbackElement.style.display = 'block';

                        // Auto-hide after 5 seconds
                        setTimeout(() => {
                            feedbackElement.style.display = 'none';
                        }, 5000);
                    }
                }
            }

            // Save answer to Supabase
            async function saveAnswerToSupabase(puzzleNumber, answerData) {
                try {
                    const {
                        error
                    } = await supabase
                        .from('day_answers')
                        .upsert({
                            user_id: currentUser.id,
                            day_number: currentDay,
                            puzzle_number: puzzleNumber,
                            answer: answerData.answer,
                            correct: answerData.correct,
                            attempts: answerData.attempts,
                            reason: answerData.reason || null,
                            answered_at: new Date().toISOString()
                        }, {
                            onConflict: 'user_id,day_number,puzzle_number'
                        });

                    if (error) throw error;

                    // Update progress in Supabase
                    await updateProgressInSupabase();

                    showSaveStatus('‚úÖ Answer saved!');

                } catch (error) {
                    console.error('Error saving answer:', error);
                    showSaveStatus('‚ùå Failed to save', 'error');
                }
            }

            // Update progress in Supabase
            async function updateProgressInSupabase() {
                try {
                    // Count completed puzzles
                    const {
                        data: answers,
                        error: answersError
                    } = await supabase
                        .from('day_answers')
                        .select('correct')
                        .eq('user_id', currentUser.id)
                        .eq('day_number', currentDay);

                    if (answersError) throw answersError;

                    const completedCount = answers.filter(a => a.correct).length;
                    const isComplete = completedCount === 5;

                    // Update progress
                    const {
                        error: progressError
                    } = await supabase
                        .from('user_progress')
                        .update({
                            progress: completedCount,
                            completed: isComplete,
                            score: completedCount * 20,
                            completed_at: isComplete ? new Date().toISOString() : null
                        })
                        .eq('user_id', currentUser.id)
                        .eq('day_number', currentDay);

                    if (progressError) throw progressError;

                    if (isComplete && !isReadOnly) {
                        // Start countdown for next day
                        await startNextDayCountdown();
                    }

                } catch (error) {
                    console.error('Error updating progress:', error);
                }
            }

            // Start countdown for next day
            async function startNextDayCountdown() {
                try {
                    const nextDay = currentDay + 1;
                    if (nextDay > 7) return;

                    // 24 hours for Jessica (girlfriend), 3 minutes for Hlakulo (test)
                    const isJessica = currentUser.is_jessica;
                    const unlockDuration = isJessica ? 24 * 60 * 60 * 1000 : 3 * 60 * 1000;
                    const nextUnlockAt = new Date(Date.now() + unlockDuration).toISOString();

                    console.log(`Countdown for Day ${nextDay}: ${isJessica ? '24 hours (Jessica real)' : '3 minutes (Hlakulo test)'}`);

                    // Create or update next day progress
                    const {
                        error
                    } = await supabase
                        .from('user_progress')
                        .upsert({
                            user_id: currentUser.id,
                            day_number: nextDay,
                            next_unlock_at: nextUnlockAt,
                            unlocked_at: null,
                            completed: false,
                            progress: 0,
                            score: 0
                        }, {
                            onConflict: 'user_id,day_number'
                        });

                    if (error) throw error;

                } catch (error) {
                    console.error('Error starting countdown:', error);
                }
            }

            // Load saved answers from Supabase
            async function loadSavedAnswers() {
                try {
                    const {
                        data: answers,
                        error
                    } = await supabase
                        .from('day_answers')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .eq('day_number', currentDay)
                        .order('puzzle_number', {
                            ascending: true
                        });

                    if (error) throw error;

                    return answers || [];

                } catch (error) {
                    console.error('Error loading saved answers:', error);
                    return [];
                }
            }

            // Restore progress from saved answers
            function restoreProgress(savedAnswers) {
                console.log('Restoring progress from:', savedAnswers);

                if (!savedAnswers || savedAnswers.length === 0) {
                    console.log('No saved answers found');
                    return;
                }

                // Mark all puzzles as completed by default in read-only mode
                if (isReadOnly) {
                    for (let i = 0; i < totalPuzzles; i++) {
                        completedPuzzles[i] = true;
                    }
                }

                savedAnswers.forEach(answer => {
                    const puzzleNum = answer.puzzle_number;

                    if (answer.correct) {
                        completedPuzzles[puzzleNum - 1] = true;

                        // Restore puzzle 1 (mood guess)
                        if (puzzleNum === 1) {
                            const options = document.querySelectorAll('#puzzle1 .option');
                            options.forEach(option => {
                                option.disabled = true;
                                if (option.dataset.answer === answer.answer) {
                                    option.classList.add('correct');
                                }
                            });
                        }
                        // Restore puzzle 2 (lyric completion)
                        else if (puzzleNum === 2) {
                            const lyricInput = document.getElementById('lyricInput');
                            const checkLyric = document.getElementById('checkLyric');
                            if (lyricInput) {
                                lyricInput.value = answer.answer;
                                lyricInput.classList.add('correct');
                                lyricInput.disabled = true;
                            }
                            if (checkLyric) checkLyric.disabled = true;
                        }
                        // Restore puzzle 3 (riddle)
                        else if (puzzleNum === 3) {
                            const riddleAnswer = document.getElementById('riddleAnswer');
                            const checkRiddle = document.getElementById('checkRiddle');
                            if (riddleAnswer) {
                                riddleAnswer.value = answer.answer;
                                riddleAnswer.classList.add('correct');
                                riddleAnswer.disabled = true;
                            }
                            if (checkRiddle) checkRiddle.disabled = true;
                        }
                        // Restore puzzle 4 (song)
                        else if (puzzleNum === 4) {
                            // Mark as completed
                            const playBtn = document.getElementById('playBtn');
                            const pauseBtn = document.getElementById('pauseBtn');
                            if (playBtn) {
                                // In read-only mode, keep play button enabled
                                if (!isReadOnly) {
                                    playBtn.disabled = false;
                                    playBtn.textContent = "‚ñ∂ Play Song";
                                } else {
                                    playBtn.disabled = false;
                                    playBtn.textContent = "‚ñ∂ Play Song";
                                }
                            }
                            if (pauseBtn) pauseBtn.disabled = true;
                            // Lyrics will be loaded when puzzle is shown
                        }
                        // Restore puzzle 5 (romantic message)
                        else if (puzzleNum === 5) {
                            const romanticMessage = document.getElementById('romanticMessage');
                            const saveMessage = document.getElementById('saveMessage');
                            if (romanticMessage) {
                                romanticMessage.value = answer.answer;
                                romanticMessage.disabled = true;
                            }
                            if (saveMessage) saveMessage.disabled = true;
                        }

                        // Don't show feedback in read-only mode
                        if (!isReadOnly) {
                            const feedbackElement = document.getElementById(`feedback${puzzleNum}`);
                            if (feedbackElement) {
                                feedbackElement.textContent = "Good";
                                feedbackElement.className = 'feedback correct';
                                feedbackElement.style.display = 'block';

                                // Hide after 2 seconds in active mode
                                setTimeout(() => {
                                    feedbackElement.style.display = 'none';
                                }, 2000);
                            }
                        }
                    } else {
                        // For wrong answers in read-only mode, still show the attempt
                        if (isReadOnly) {
                            if (puzzleNum === 1) {
                                const options = document.querySelectorAll('#puzzle1 .option');
                                options.forEach(option => {
                                    option.disabled = true;
                                    if (option.dataset.answer === answer.answer) {
                                        option.classList.add('wrong');
                                    }
                                });
                            }
                        }
                    }
                });

                console.log('Completed puzzles after restore:', completedPuzzles);
            }

            // Complete the day
            async function completeDay() {
                try {
                    // Mark day as complete in Supabase
                    const {
                        error
                    } = await supabase
                        .from('user_progress')
                        .update({
                            completed: true,
                            completed_at: new Date().toISOString()
                        })
                        .eq('user_id', currentUser.id)
                        .eq('day_number', currentDay);

                    if (error) throw error;

                    // Redirect to dashboard after delay
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 500);

                } catch (error) {
                    console.error('Error completing day:', error);
                }
            }

            // Show save status
            function showSaveStatus(message, type = 'success') {
                const status = document.getElementById('saveStatus');
                if (status) {
                    status.textContent = message;
                    status.style.color = type === 'success' ? '#28a745' : '#dc3545';
                    status.style.display = 'block';

                    setTimeout(() => {
                        status.style.display = 'none';
                    }, 3000);
                }
            }

            // Function to set up read-only mode
            function setupReadOnlyMode() {
                console.log('Setting up read-only mode...');

                // Update header
                const dayTitle = document.getElementById('dayTitle');
                if (dayTitle) {
                    dayTitle.innerHTML = 'Day 4: Completed ‚úÖ <span class="completed-badge">READ ONLY</span>';
                }

                // Update day indicator
                const dayIndicator = document.getElementById('dayIndicator');
                if (dayIndicator) {
                    dayIndicator.textContent = 'Day 4 of 7 (Completed)';
                }

                // Show completed message
                if (completedMessage) {
                    completedMessage.style.display = 'block';
                }

                // Hide complete button
                if (completeBtn) {
                    completeBtn.style.display = 'none';
                }

                // Add read-only class to body
                document.body.classList.add('read-only-mode');

                // Disable all interactive elements except navigation and audio buttons
                const allOptions = document.querySelectorAll('.option');
                allOptions.forEach(option => {
                    option.disabled = true;
                    option.style.cursor = 'default';
                });

                const allInputs = document.querySelectorAll('input, textarea, button:not(.back-btn):not(.nav-btn):not(.player-btn):not(.play-btn)');
                allInputs.forEach(input => {
                    input.disabled = true;
                });

                // Load and display saved answers immediately
                loadSavedAnswers().then(savedAnswers => {
                    console.log('Loading answers for read-only mode:', savedAnswers);
                    if (savedAnswers && savedAnswers.length > 0) {
                        restoreProgress(savedAnswers);
                        // Force update the progress display
                        updateProgress();
                    } else {
                        console.log('No saved answers found for read-only mode');
                    }
                });
            }

            // Initialize the quiz
            showPuzzle(1);
            setupEventListeners();
        }

        function showDBStatus(message, type = '') {
            const statusBar = document.getElementById('dbStatus');
            if (statusBar) {
                statusBar.textContent = message;
                statusBar.className = `db-status ${type}`;
                statusBar.style.display = 'block';
            }
        }

        function hideDBStatus() {
            const statusBar = document.getElementById('dbStatus');
            if (statusBar) {
                statusBar.style.display = 'none';
            }
        }
    </script>
</body>

</html>