<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Day 7: The Finale</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 40px 20px;
            overflow-y: auto;
        }
        
        .container {
            width: 100%;
            max-width: 900px;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(255, 154, 158, 0.3);
        }
        
        .header {
            background: linear-gradient(135deg, #ff9a9e, #fad0c4);
            color: white;
            padding: 30px 25px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .progress {
            margin-top: 15px;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .nav-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        
        .back-btn {
            padding: 10px 20px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .day-indicator {
            font-weight: 600;
            color: #ff9a9e;
            font-size: 1.1rem;
        }
        
        .db-status {
            background: #e3f2fd;
            border: 2px solid #bbdefb;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 25px;
            color: #1565c0;
            font-weight: 600;
            text-align: center;
            display: none;
        }
        
        .db-status.success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .db-status.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        .progress-bar {
            height: 10px;
            background: #e0e0e0;
            margin-top: 15px;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #ff9a9e, #fad0c4);
            transition: width 0.5s ease;
        }
        
        .progress-dots {
            display: flex;
            justify-content: space-between;
            margin-top: -15px;
        }
        
        .dot {
            width: 40px;
            height: 40px;
            background: #e0e0e0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #666;
            z-index: 1;
        }
        
        .dot.active {
            background: #ff9a9e;
            color: white;
            transform: scale(1.1);
        }
        
        .dot.completed {
            background: #fad0c4;
            color: white;
        }
        
        .puzzle-content {
            padding: 40px;
            min-height: 600px;
        }
        
        .puzzle {
            display: none;
            animation: fadeIn 0.5s ease;
            padding: 20px 0;
        }
        
        .puzzle.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .puzzle h2 {
            color: #333;
            font-size: 1.8rem;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .lyrics-quiz {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            text-align: center;
        }
        
        .lyrics-box {
            background: #fff0f5;
            border: 2px solid #ff9a9e;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            font-style: italic;
            color: #333;
            line-height: 1.6;
            text-align: center;
            font-size: 1.2rem;
        }
        
        .text-input {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin: 40px 0;
        }
        
        .text-input input {
            padding: 20px;
            border: 3px solid #dee2e6;
            border-radius: 12px;
            font-size: 1.3rem;
            width: 300px;
            text-align: center;
        }
        
        .text-input button {
            padding: 20px 40px;
            background: #ff9a9e;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.3rem;
            cursor: pointer;
            font-weight: 600;
        }
        
        .text-input button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .victory-song-container {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            text-align: center;
        }
        
        .player-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }
        
        .player-btn {
            padding: 15px 30px;
            background: #ff9a9e;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            cursor: pointer;
            font-weight: 600;
        }
        
        .player-btn:hover:not(:disabled) {
            background: #fad0c4;
            transform: scale(1.05);
        }
        
        .player-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .audio-error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
        }
        
        .achievement-board {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 3px solid #ffd166;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            text-align: center;
        }
        
        .achievement-title {
            color: #856404;
            font-size: 1.8rem;
            margin-bottom: 30px;
            font-weight: 600;
        }
        
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 30px 0;
        }
        
        .achievement-card {
            background: white;
            border: 2px solid #ffd166;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .achievement-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(255, 209, 102, 0.2);
        }
        
        .achievement-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        
        .achievement-name {
            color: #333;
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .achievement-desc {
            color: #666;
            font-size: 1rem;
            line-height: 1.4;
        }
        
        .pictures-grid {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .day7-picture {
            width: 250px;
            height: 250px;
            border-radius: 15px;
            object-fit: cover;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .day7-picture:hover {
            transform: scale(1.05);
        }
        
        .video-container {
            background: linear-gradient(135deg, #f0f9ff, #e6f7ff);
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            text-align: center;
        }
        
        .final-video {
            width: 100%;
            max-width: 600px;
            border-radius: 12px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .final-picture-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 30px 0;
        }
        
        .final-picture {
            max-width: 400px;
            max-height: 400px;
            border-radius: 15px;
            object-fit: cover;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .thank-you-message {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border: 3px solid #28a745;
            border-radius: 15px;
            padding: 40px;
            margin: 30px 0;
            text-align: center;
            color: #155724;
            line-height: 1.8;
            font-size: 1.3rem;
        }
        
        .complete-btn {
            padding: 20px 50px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 1.4rem;
            font-weight: 600;
            cursor: pointer;
            display: none;
            margin: 30px auto;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.4);
            }
            50% {
                box-shadow: 0 0 0 20px rgba(40, 167, 69, 0);
            }
        }
        
        .feedback {
            padding: 20px;
            margin: 25px auto;
            border-radius: 15px;
            font-size: 1.3rem;
            font-weight: 600;
            text-align: center;
            max-width: 600px;
            display: none;
        }
        
        .feedback.correct {
            background: #d4edda;
            color: #155724;
            border: 3px solid #c3e6cb;
        }
        
        .feedback.incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 3px solid #f5c6cb;
        }
        
        .special-message {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        
        .message-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: scaleIn 0.3s ease;
        }
        
        @keyframes scaleIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .message-box h3 {
            color: #ff9a9e;
            font-size: 1.8rem;
            margin-bottom: 20px;
        }
        
        .message-box p {
            color: #333;
            font-size: 1.2rem;
            line-height: 1.6;
            margin-bottom: 30px;
        }
        
        .message-box button {
            padding: 15px 40px;
            background: #ff9a9e;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
        }
        
        .hint-box {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            color: #856404;
            font-style: italic;
            text-align: center;
        }
        
        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 50px;
            padding: 30px 0;
            border-top: 2px solid #e9ecef;
        }
        
        .nav-btn {
            padding: 18px 35px;
            font-size: 1.2rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .prev-btn {
            background: #6c757d;
            color: white;
        }
        
        .next-btn {
            background: #ff9a9e;
            color: white;
        }
        
        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .footer {
            text-align: center;
            padding: 25px;
            background: #f8f9fa;
            color: #666;
            border-top: 2px solid #e9ecef;
        }
        
        .save-status {
            text-align: center;
            color: #28a745;
            font-weight: 600;
            margin: 20px 0;
            font-size: 1.1rem;
            min-height: 24px;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
            flex-direction: column;
            gap: 20px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #ffebee;
            border-top: 5px solid #ff9a9e;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        
        .read-only-mode .option,
        .read-only-mode input,
        .read-only-mode textarea,
        .read-only-mode button:not(.back-btn):not(.nav-btn):not(.player-btn):not(.save-btn) {
            opacity: 0.8;
            cursor: default !important;
        }
        
        .read-only-mode .option:hover {
            transform: none !important;
            box-shadow: none !important;
            border-color: #dee2e6 !important;
        }
        
        .read-only-mode .container {
            border: 3px solid #fad0c4;
        }
        
        .completed-badge {
            background: #fad0c4;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .completed-message {
            background: #d4edda;
            color: #155724;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            font-weight: 600;
            border: 2px solid #c3e6cb;
        }
        
        .pictures-title {
            text-align: center;
            color: #333;
            font-size: 1.5rem;
            font-weight: 600;
            margin: 30px 0 20px 0;
            font-style: italic;
        }
        
        .save-btn {
            padding: 15px 30px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            cursor: pointer;
            font-weight: 600;
            margin-top: 20px;
            transition: all 0.3s ease;
        }
        
        .save-btn:hover {
            background: #45a049;
            transform: scale(1.05);
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            .header {
                padding: 20px 15px;
            }
            .header h1 {
                font-size: 1.8rem;
            }
            .puzzle-content {
                padding: 20px;
            }
            .achievements-grid {
                grid-template-columns: 1fr;
            }
            .pictures-grid {
                flex-direction: column;
                align-items: center;
            }
            .day7-picture {
                width: 200px;
                height: 200px;
            }
            .final-picture {
                max-width: 300px;
                max-height: 300px;
            }
            .player-controls {
                flex-direction: column;
                align-items: center;
            }
            .player-btn {
                width: 100%;
                max-width: 250px;
            }
            .navigation {
                flex-direction: column;
                gap: 10px;
            }
            .nav-btn {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Database Status -->
        <div id="dbStatus" class="db-status">üîÑ Checking access...</div>

        <!-- Loading State -->
        <div id="loadingDay" class="loading">
            <div class="spinner"></div>
            <p>Loading Day 7...</p>
        </div>

        <!-- Main Content (hidden initially) -->
        <div id="dayContent" style="display: none;">
            <!-- Header -->
            <div class="header">
                <h1 id="dayTitle">Day 7: The Finale</h1>
                <div class="progress">Stage <span id="currentStage">1</span>/6</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-dots">
                    <div class="dot active">1</div>
                    <div class="dot">2</div>
                    <div class="dot">3</div>
                    <div class="dot">4</div>
                    <div class="dot">5</div>
                    <div class="dot">6</div>
                </div>
            </div>

            <!-- Navigation Bar -->
            <div class="nav-bar">
                <a href="dashboard.html" class="back-btn">‚Üê Back to Dashboard</a>
                <div id="dayIndicator" class="day-indicator">Day 7 of 7 (Final Day!)</div>
            </div>

            <!-- Puzzle Content -->
            <div class="puzzle-content">
                <!-- Completed Message (only shown in read-only mode) -->
                <div id="completedMessage" class="completed-message" style="display: none;">
                    You've already completed this final day! Viewing in read-only mode. Enjoy the memories! ‚ù§Ô∏è
                </div>

                <!-- Stage 1: Lyrics Quiz -->
                <div id="puzzle1" class="puzzle active">
                    <h2>Final Lyrics Challenge üéµ</h2>
                    <div class="lyrics-box">
                        "Mbilu ya mina yo ti lavela _____"
                    </div>
                    <div class="hint-box">
                        üí° Complete the lyric with one word
                    </div>
                    <div class="text-input">
                        <input type="text" id="lyricsInput" placeholder="Enter the missing word" maxlength="10">
                        <button id="checkLyrics">Submit Answer</button>
                    </div>
                    <div id="feedback1" class="feedback"></div>
                </div>

                <!-- Stage 2: Victory Song -->
                <div id="puzzle2" class="puzzle">
                    <h2>üé∂ Victory Song üé∂</h2>
                    <p style="margin-bottom: 20px; color: #666;"></p>
                    <div class="player-controls">
                        <button id="playVictorySong" class="player-btn">‚ñ∂ Play Victory Song</button>
                        <button id="pauseVictorySong" class="player-btn" style="background: #fad0c4;" disabled>‚è∏ Pause</button>
                    </div>
                    <div class="audio-error" id="audioError"></div>
                </div>

                <!-- Stage 3: Achievements -->
                <div id="puzzle3" class="puzzle">
                    <h2 class="achievement-title">üèÜ Your Achievement Board üèÜ</h2>
                    <div class="achievements-grid">
                        <div class="achievement-card">
                            <div class="achievement-icon">üß†</div>
                            <div class="achievement-name">Something New You Know</div>
                            <div class="achievement-desc">My Shoe Size, My family nickname, I can get this creative üòÇ </div>
                        </div>
                        <div class="achievement-card">
                            <div class="achievement-icon">ü•≥</div>
                            <div class="achievement-name">Patience</div>
                            <div class="achievement-desc">I love that you took you time and attend this for the past 6 days (I know it's because you like me) But that means a lot to me tbh ü•∫</div>
                        </div>
                        <div class="achievement-card">
                            <div class="achievement-icon">üòä</div>
                            <div class="achievement-name">Blushed 99 Times</div>
                            <div class="achievement-desc">I know you did üòÇ</div>
                        </div>
                        <div class="achievement-card">
                            <div class="achievement-icon">üíç</div>
                            <div class="achievement-name">Future W Partner</div>
                            <div class="achievement-desc">You deserve it</div>
                        </div>
                    </div>

                    <!-- Pictures Section -->
                    <h3 class="pictures-title">This is for you</h3>
                    <div class="pictures-grid">
                        <img src="assets/pictures/day7-pic1.png" alt="Memory 1" class="day7-picture">
                        <img src="assets/pictures/day7-pic2.png" alt="Memory 2" class="day7-picture">
                        <img src="assets/pictures/day7-pic3.png" alt="Memory 3" class="day7-picture">
                    </div>
                </div>

                <!-- Stage 4: Video -->
                <div id="puzzle4" class="puzzle">
                    <h2>This is the surprise üòÇ‚ù§Ô∏è, I'm the surprise üòÇ. I hope you love it thoughü´† </h2>
                    <p style="margin-bottom: 20px; color: #666;"></p>
                    <video id="finalVideo" class="final-video" controls>
                        <source src="assets/videos/surprise.mp4" type="video/mp4">
                        <source src="assets/videos/surprise.m4v" type="video/mp4">
                        <source src="assets/videos/surprise.webm" type="video/webm">
                        Your browser does not support the video tag.
                    </video>
                    <button id="downloadVideo" class="save-btn">Save this video, but wait? there's something missing you can't save the video üò≠  </button>
                </div>

                <!-- Stage 5: Final Picture -->
                <div id="puzzle5" class="puzzle">
                    <h2>ME üòÇ</h2>
                    <div class="final-picture-container">
                        <img src="assets/pictures/day7-final.jpg" alt="ME" class="final-picture">
                        <button id="downloadPicture" class="save-btn">Save this picture then, after clicking this, tap and hold the picture until you see the save image as üòâ. Send me this picture and get the video ü´† </button>
                    </div>
                </div>

                <!-- Stage 6: Thank You Message -->
                <div id="puzzle6" class="puzzle">
                    <div class="thank-you-message">
                        <h2 style="color: #155724; margin-bottom: 20px;">‚ù§Ô∏èI appreciate you‚ù§Ô∏è</h2>
                        <p>Thank you for going through this journey with me. </p>
                        <p style="margin-top: 15px;">Every moment, every answer, every memory, they all mean so much.</p>
                        <p style="margin-top: 15px; font-weight: 600;">‚ù§Ô∏èI Love You‚ù§Ô∏è </p>
                    </div>

                    <!-- Complete Button under the thank you message -->
                    <div style="text-align: center; margin-top: 40px;">
                        <button id="completeBtn" class="complete-btn">Complete The Journey ‚ù§Ô∏è</button>
                    </div>
                </div>

                <!-- Navigation -->
                <div class="navigation">
                    <button id="prevBtn" class="nav-btn prev-btn" disabled>‚Üê Previous</button>
                    <button id="nextBtn" class="nav-btn next-btn">Next Stage ‚Üí</button>
                </div>

                <!-- Save Status -->
                <div id="saveStatus" class="save-status"></div>
            </div>

            <!-- Footer -->
            <div class="footer">
                <p>Made by Hlakulo (Your ‚ù§Ô∏è) </p>
            </div>
        </div>
    </div>

    <!-- Special Message Popup -->
    <div id="specialMessage" class="special-message">
        <div class="message-box">
            <h3 id="messageTitle">Special Message! üíï</h3>
            <p id="messageText"></p>
            <button id="closeMessage">Continue</button>
        </div>
    </div>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://yqxrsigblsalvhndfvvs.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlxeHJzaWdibHNhbHZobmRmdnZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNDUwNjQsImV4cCI6MjA4MDYyMTA2NH0.gsj4ya1LMKNtWGdwhaDa91L81AdOc6E1BcBd2gwXcJc';

        // Global variables
        let supabase;
        let currentUser = null;
        let currentDay = 7;
        let isReadOnly = false;
        let victoryAudio = null;
        let videoWatched = false;
        let videoWasPlaying = false;
        let audioWasPlaying = false;
        let currentPuzzle = 1;
        const totalPuzzles = 6;

        // Correct answer
        const CORRECT_ANSWER = 'wena';

        // Main initialization
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Day 7: DOM loaded');
            await checkAuthentication();
        });

        // Authentication check - SESSIONSTORAGE ONLY (like Day 6)
        async function checkAuthentication() {
            console.log('Checking authentication...');

            const sessionData = sessionStorage.getItem('currentUser');

            if (sessionData) {
                try {
                    currentUser = JSON.parse(sessionData);
                    console.log('Found user in sessionStorage:', currentUser.username);

                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

                    await initializeDay();

                } catch (error) {
                    console.error('Error parsing sessionStorage:', error);
                    redirectToLogin();
                }
            } else {
                console.log('NO USER FOUND - Redirecting to login');
                redirectToLogin();
            }
        }

        function redirectToLogin() {
            showDBStatus('‚ùå Please login first!', 'error');
            setTimeout(() => {
                sessionStorage.clear();
                window.location.href = 'index.html';
            }, 1500);
        }

        async function initializeDay() {
            console.log('Initializing Day 7 for user:', currentUser.username);
            showDBStatus('üîê Checking Day 7 access...');

            try {
                const {
                    data: progress,
                    error
                } = await supabase
                    .from('user_progress')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .eq('day_number', currentDay)
                    .single();

                if (error) {
                    if (error.code === 'PGRST116') {
                        console.log('No Day 7 progress found, checking Day 6 completion...');

                        const {
                            data: day6Progress
                        } = await supabase
                            .from('user_progress')
                            .select('completed')
                            .eq('user_id', currentUser.id)
                            .eq('day_number', 6)
                            .single();

                        if (!day6Progress || !day6Progress.completed) {
                            showDBStatus('‚ùå Complete Day 6 first!', 'error');
                            setTimeout(() => {
                                window.location.href = 'dashboard.html';
                            }, 2000);
                            return;
                        }

                        await createDayProgress();
                    } else {
                        console.error('Error checking progress:', error);
                        throw error;
                    }
                } else {
                    console.log('Day 7 progress found:', progress);

                    if (!progress.unlocked_at && !progress.completed) {
                        showDBStatus('‚ùå Day 7 is locked', 'error');
                        setTimeout(() => {
                            window.location.href = 'dashboard.html';
                        }, 1500);
                        return;
                    }

                    if (progress.completed) {
                        console.log('Day 7 is completed - read-only mode');
                        isReadOnly = true;
                    }
                }

                console.log('Access granted! Read-only:', isReadOnly);
                showDBStatus('‚úÖ Access granted!', 'success');

                setTimeout(() => {
                    hideDBStatus();
                    document.getElementById('loadingDay').style.display = 'none';
                    document.getElementById('dayContent').style.display = 'block';
                    initializeQuiz();
                }, 1000);

            } catch (error) {
                console.error('Error initializing day:', error);
                showDBStatus('‚ùå Error: ' + error.message, 'error');
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 2000);
            }
        }

        async function createDayProgress() {
            const {
                error
            } = await supabase
                .from('user_progress')
                .insert([{
                    user_id: currentUser.id,
                    day_number: currentDay,
                    unlocked_at: new Date().toISOString(),
                    next_unlock_at: null,
                    completed: false,
                    progress: 0,
                    score: 0,
                    answers: {}
                }]);

            if (error) throw error;
        }

        function initializeQuiz() {
            console.log('Initializing Day 7 quiz...');

            // Create audio element for victory song
            createAudioElement();

            // Quiz state
            const completedPuzzles = new Array(totalPuzzles).fill(false);

            // DOM Elements
            const currentStageSpan = document.getElementById('currentStage');
            const progressFill = document.getElementById('progressFill');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const completeBtn = document.getElementById('completeBtn');
            const dots = document.querySelectorAll('.dot');
            const specialMessage = document.getElementById('specialMessage');
            const messageText = document.getElementById('messageText');
            const messageTitle = document.getElementById('messageTitle');
            const closeMessage = document.getElementById('closeMessage');
            const completedMessage = document.getElementById('completedMessage');
            const finalVideo = document.getElementById('finalVideo');

            // Set up read-only mode if day is completed
            if (isReadOnly) {
                setupReadOnlyMode();
                for (let i = 0; i < totalPuzzles; i++) {
                    completedPuzzles[i] = true;
                }
            }

            // Function to show specific puzzle
            function showPuzzle(num) {
                console.log('Showing puzzle', num, 'from', currentPuzzle);

                // Pause video if leaving video stage
                if (currentPuzzle === 4 && num !== 4) {
                    const video = document.getElementById('finalVideo');
                    if (video && !video.paused) {
                        video.pause();
                        videoWasPlaying = true;
                    }
                }

                // Resume audio if leaving video stage and audio was playing before
                if (currentPuzzle === 4 && num !== 4 && victoryAudio && audioWasPlaying) {
                    victoryAudio.play().catch(e => console.log('Could not resume audio:', e));
                }

                // Hide all puzzles
                for (let i = 1; i <= totalPuzzles; i++) {
                    const puzzle = document.getElementById(`puzzle${i}`);
                    if (puzzle) {
                        puzzle.classList.remove('active');
                    }
                }

                // Show current puzzle
                const currentPuzzleElement = document.getElementById(`puzzle${num}`);
                if (currentPuzzleElement) {
                    currentPuzzleElement.classList.add('active');
                    currentPuzzle = num;
                }

                // Update UI
                updateProgress();
                updateNavigation();
                updateCompleteButton();
            }

            // Update progress display
            function updateProgress() {
                if (currentStageSpan) currentStageSpan.textContent = currentPuzzle;

                const completedCount = completedPuzzles.filter(c => c).length;
                const progressPercent = ((completedCount + (currentPuzzle - 1)) / totalPuzzles) * 100;
                if (progressFill) progressFill.style.width = `${progressPercent}%`;

                dots.forEach((dot, index) => {
                    const puzzleNum = index + 1;
                    dot.classList.remove('active', 'completed');

                    if (puzzleNum === currentPuzzle) {
                        dot.classList.add('active');
                    } else if (completedPuzzles[puzzleNum - 1]) {
                        dot.classList.add('completed');
                    }
                });
            }

            // Update complete button visibility
            function updateCompleteButton() {
                if (!completeBtn || isReadOnly) return;

                // Show button only on puzzle 6 (thank you message)
                if (currentPuzzle === 6) {
                    completeBtn.style.display = 'block';
                    completeBtn.disabled = false;
                } else {
                    completeBtn.style.display = 'none';
                }
            }

            // Update navigation buttons
            function updateNavigation() {
                if (prevBtn) prevBtn.disabled = currentPuzzle === 1;
                if (nextBtn) nextBtn.disabled = currentPuzzle === totalPuzzles;
            }

            // Setup all event listeners
            function setupEventListeners() {
                console.log('Setting up event listeners...');

                // Previous/Next buttons
                if (prevBtn) {
                    prevBtn.addEventListener('click', function() {
                        if (currentPuzzle > 1) {
                            showPuzzle(currentPuzzle - 1);
                        }
                    });
                }

                if (nextBtn) {
                    nextBtn.addEventListener('click', function() {
                        if (currentPuzzle < totalPuzzles) {
                            showPuzzle(currentPuzzle + 1);
                        }
                    });
                }

                // Complete button (only in active mode)
                if (completeBtn && !isReadOnly) {
                    completeBtn.addEventListener('click', async function() {
                        // Disable button to prevent double-click
                        completeBtn.disabled = true;
                        completeBtn.textContent = "Completing...";

                        // Mark day as complete
                        const success = await completeDay();

                        if (success) {
                            // Show success message
                            showSpecialMessage("CONGRATULATIONS! ü•≥, Yima ucina, I know you are happy üòÇ. Remember you almost missed out on this? üòÇüòÇ, give me credits for being the creative.......? Bye ", true);

                            // Redirect after delay
                            setTimeout(() => {
                                window.location.href = 'dashboard.html';
                            }, 10000);
                        } else {
                            // Re-enable button on error
                            completeBtn.disabled = false;
                            completeBtn.textContent = "Complete The Journey ‚ù§Ô∏è";
                            showSaveStatus('‚ùå Failed to save completion', 'error');
                        }
                    });
                }

                // Close message button
                if (closeMessage) {
                    closeMessage.addEventListener('click', function() {
                        specialMessage.style.display = 'none';
                    });
                }

                // Download video button
                document.getElementById('downloadVideo').addEventListener('click', function() {
                    downloadFile('assets/videos/surprise.mp4', 'surprise_video.mp4');
                });

                // Download picture button
                document.getElementById('downloadPicture').addEventListener('click', function() {
                    downloadFile('assets/pictures/day7-final.jpg', 'ME.jpg');
                });

                // Load saved answers
                loadSavedAnswers().then(savedAnswers => {
                    console.log('Loaded saved answers:', savedAnswers);
                    if (savedAnswers && savedAnswers.length > 0) {
                        restoreProgress(savedAnswers);
                        updateProgress();
                        updateCompleteButton();
                    }

                    showPuzzle(1);

                    if (!isReadOnly) {
                        setupPuzzle1();
                    }

                    setupAudioPlayer();
                    setupVideoPlayer();
                });
            }

            // Setup Puzzle 1 (Lyrics quiz) - ONLY FOR ACTIVE MODE
            function setupPuzzle1() {
                const lyricsInput = document.getElementById('lyricsInput');
                const checkLyricsBtn = document.getElementById('checkLyrics');

                if (!lyricsInput || !checkLyricsBtn) return;

                checkLyricsBtn.addEventListener('click', checkLyricsAnswer);

                lyricsInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        checkLyricsAnswer();
                    }
                });
            }

            // Check lyrics answer
            function checkLyricsAnswer() {
                const lyricsInput = document.getElementById('lyricsInput');
                const userAnswer = lyricsInput.value.trim().toLowerCase();
                const feedback = document.getElementById('feedback1');

                if (!userAnswer) {
                    feedback.textContent = "Please enter an answer!";
                    feedback.className = 'feedback incorrect';
                    feedback.style.display = 'block';
                    return;
                }

                const isCorrect = userAnswer === CORRECT_ANSWER.toLowerCase();

                if (isCorrect) {
                    lyricsInput.classList.add('correct');
                    lyricsInput.disabled = true;
                    document.getElementById('checkLyrics').disabled = true;
                    completedPuzzles[0] = true;

                    feedback.textContent = "Correct! Well done! ü´†";
                    feedback.className = 'feedback correct';
                    feedback.style.display = 'block';

                    saveAnswerToSupabase();
                    updateProgress();
                    updateCompleteButton();

                    // Automatically advance to next stage after correct answer
                    setTimeout(() => {
                        if (currentPuzzle < totalPuzzles) {
                            showPuzzle(currentPuzzle + 1);
                        }
                    }, 1000);
                } else {
                    lyricsInput.classList.add('wrong ü•≤');

                    feedback.textContent = "Try again!";
                    feedback.className = 'feedback incorrect';
                    feedback.style.display = 'block';

                    setTimeout(() => {
                        feedback.style.display = 'none';
                    }, 3000);

                    setTimeout(() => {
                        lyricsInput.classList.remove('wrong ü•≤');
                        lyricsInput.value = '';
                        lyricsInput.focus();
                    }, 1000);
                }
            }

            // Create audio element for victory song
            function createAudioElement() {
                victoryAudio = new Audio('assets/songs/day7-victory.mp3');
                victoryAudio.preload = 'auto';

                victoryAudio.addEventListener('error', function(e) {
                    console.error('Audio error:', e);
                    const errorMsg = document.getElementById('audioError');
                    if (errorMsg) {
                        errorMsg.textContent = "‚ö†Ô∏è Could not load audio file. Please check if assets/songs/day7-victory.mp3 exists.";
                        errorMsg.style.display = 'block';
                    }
                });

                victoryAudio.addEventListener('canplaythrough', function() {
                    console.log('Victory audio is ready to play');
                    const playBtn = document.getElementById('playVictorySong');
                    if (playBtn) {
                        playBtn.disabled = false;
                    }
                });

                victoryAudio.addEventListener('ended', function() {
                    const playBtn = document.getElementById('playVictorySong');
                    const pauseBtn = document.getElementById('pauseVictorySong');
                    if (playBtn) playBtn.textContent = "‚ñ∂ Play Victory Song";
                    if (pauseBtn) pauseBtn.disabled = true;
                });
            }

            // Setup audio player - WORKS IN BOTH MODES
            function setupAudioPlayer() {
                const playBtn = document.getElementById('playVictorySong');
                const pauseBtn = document.getElementById('pauseVictorySong');
                const audioError = document.getElementById('audioError');

                if (!playBtn || !pauseBtn) return;

                playBtn.addEventListener('click', async function() {
                    try {
                        if (victoryAudio.ended) {
                            victoryAudio.currentTime = 0;
                        }

                        playBtn.disabled = true;
                        playBtn.textContent = "Loading...";
                        if (audioError) audioError.style.display = 'none';

                        await victoryAudio.play();

                        playBtn.textContent = "Playing...";
                        playBtn.disabled = true;
                        pauseBtn.disabled = false;

                    } catch (error) {
                        console.error('Error playing audio:', error);
                        if (audioError) {
                            audioError.textContent = "Error playing audio. Make sure assets/songs/day7-victory.mp3 exists.";
                            audioError.style.display = 'block';
                        }
                        playBtn.disabled = false;
                        playBtn.textContent = "‚ñ∂ Play Victory Song";
                    }
                });

                pauseBtn.addEventListener('click', function() {
                    if (!victoryAudio.paused) {
                        victoryAudio.pause();
                        playBtn.disabled = false;
                        playBtn.textContent = "‚ñ∂ Play Victory Song";
                        pauseBtn.disabled = true;
                    }
                });
            }

            // Setup video player - WITH AUDIO MANAGEMENT
            function setupVideoPlayer() {
                const finalVideo = document.getElementById('finalVideo');
                if (!finalVideo) return;

                // Video play event - pause audio
                finalVideo.addEventListener('play', function() {
                    if (victoryAudio && !victoryAudio.paused) {
                        victoryAudio.pause();
                        audioWasPlaying = true;
                    }
                });

                // Video pause event - resume audio if it was playing
                finalVideo.addEventListener('pause', function() {
                    if (victoryAudio && audioWasPlaying) {
                        victoryAudio.play().catch(e => console.log('Could not resume audio:', e));
                        audioWasPlaying = false;
                    }
                });

                // Video ended event
                finalVideo.addEventListener('ended', function() {
                    videoWatched = true;
                    completedPuzzles[3] = true;

                    updateProgress();
                    updateCompleteButton();

                    saveVideoWatched();

                    // Resume audio after video ends
                    if (victoryAudio && audioWasPlaying) {
                        victoryAudio.play().catch(e => console.log('Could not resume audio after video:', e));
                        audioWasPlaying = false;
                    }

                    showSaveStatus('‚úÖ Video watched! You can continue to next stage.', 'success');
                });
            }

            // Download file function
            function downloadFile(url, filename) {
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showSaveStatus('‚úÖ Download started!');
            }

            // Save answer to Supabase
            async function saveAnswerToSupabase() {
                try {
                    const {
                        error
                    } = await supabase
                        .from('day_answers')
                        .upsert({
                            user_id: currentUser.id,
                            day_number: currentDay,
                            puzzle_number: 1,
                            answer: CORRECT_ANSWER,
                            correct: true,
                            attempts: 1,
                            answered_at: new Date().toISOString()
                        }, {
                            onConflict: 'user_id,day_number,puzzle_number'
                        });

                    if (error) throw error;

                    showSaveStatus('‚úÖ Progress saved!');

                } catch (error) {
                    console.error('Error saving answer:', error);
                    showSaveStatus('‚ùå Failed to save', 'error');
                }
            }

            // Save video watched status
            async function saveVideoWatched() {
                try {
                    const {
                        error
                    } = await supabase
                        .from('day_answers')
                        .upsert({
                            user_id: currentUser.id,
                            day_number: currentDay,
                            puzzle_number: 4,
                            answer: 'video_watched',
                            correct: true,
                            attempts: 1,
                            answered_at: new Date().toISOString()
                        }, {
                            onConflict: 'user_id,day_number,puzzle_number'
                        });

                    if (error) throw error;

                } catch (error) {
                    console.error('Error saving video watched:', error);
                }
            }

            // Show special message popup
            function showSpecialMessage(message, isDayComplete = false) {
                if (!messageText || !messageTitle) return;

                messageText.textContent = message;
                messageTitle.textContent = isDayComplete ? "Journey Complete! ‚ù§Ô∏è" : "Special Message! üíï";
                if (specialMessage) {
                    specialMessage.style.display = 'flex';
                }

                if (isDayComplete && closeMessage) {
                    closeMessage.textContent = "Return to Dashboard";
                }
            }

            // Complete the day - MARK DAY AS COMPLETED IN DATABASE
            async function completeDay() {
                try {
                    // Mark all puzzles as completed
                    for (let i = 0; i < totalPuzzles; i++) {
                        if (!completedPuzzles[i]) {
                            completedPuzzles[i] = true;
                        }
                    }

                    const {
                        error
                    } = await supabase
                        .from('user_progress')
                        .update({
                            completed: true,
                            completed_at: new Date().toISOString(),
                            progress: 100,
                            score: 100
                        })
                        .eq('user_id', currentUser.id)
                        .eq('day_number', currentDay);

                    if (error) throw error;

                    // Update local state
                    isReadOnly = true;

                    showSaveStatus('‚úÖ Journey completed successfully!', 'success');
                    return true;

                } catch (error) {
                    console.error('Error completing day:', error);
                    showSaveStatus('‚ùå Failed to complete day', 'error');
                    return false;
                }
            }

            // Load saved answers from Supabase
            async function loadSavedAnswers() {
                try {
                    const {
                        data: answers,
                        error
                    } = await supabase
                        .from('day_answers')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .eq('day_number', currentDay)
                        .order('puzzle_number', {
                            ascending: true
                        });

                    if (error) throw error;

                    return answers || [];

                } catch (error) {
                    console.error('Error loading saved answers:', error);
                    return [];
                }
            }

            // Restore progress from saved answers
            function restoreProgress(savedAnswers) {
                console.log('Restoring progress from:', savedAnswers);

                if (!savedAnswers || savedAnswers.length === 0) {
                    console.log('No saved answers found');
                    return;
                }

                savedAnswers.forEach(answer => {
                    const puzzleNum = answer.puzzle_number;

                    if (answer.correct) {
                        completedPuzzles[puzzleNum - 1] = true;

                        if (puzzleNum === 1) {
                            const lyricsInput = document.getElementById('lyricsInput');
                            const checkLyricsBtn = document.getElementById('checkLyrics');
                            if (lyricsInput) {
                                lyricsInput.value = answer.answer;
                                lyricsInput.classList.add('correct');
                                lyricsInput.disabled = true;
                            }
                            if (checkLyricsBtn) checkLyricsBtn.disabled = true;
                        } else if (puzzleNum === 4) {
                            videoWatched = true;
                            completedPuzzles[3] = true;
                        }
                    }
                });
            }

            // Show save status
            function showSaveStatus(message, type = 'success') {
                const status = document.getElementById('saveStatus');
                if (status) {
                    status.textContent = message;
                    status.style.color = type === 'success' ? '#28a745' : '#dc3545';
                    status.style.display = 'block';

                    setTimeout(() => {
                        status.style.display = 'none';
                    }, 3000);
                }
            }

            // Function to set up read-only mode
            function setupReadOnlyMode() {
                console.log('Setting up read-only mode...');

                const dayTitle = document.getElementById('dayTitle');
                if (dayTitle) {
                    dayTitle.innerHTML = 'Day 7: Completed ‚úÖ <span class="completed-badge">READ ONLY</span>';
                }

                const dayIndicator = document.getElementById('dayIndicator');
                if (dayIndicator) {
                    dayIndicator.textContent = 'Day 7 of 7 (Completed)';
                }

                if (completedMessage) {
                    completedMessage.style.display = 'block';
                }

                const completeBtn = document.getElementById('completeBtn');
                if (completeBtn) {
                    completeBtn.style.display = 'none';
                }

                document.body.classList.add('read-only-mode');

                const lyricsInput = document.getElementById('lyricsInput');
                const checkLyricsBtn = document.getElementById('checkLyrics');
                if (lyricsInput) lyricsInput.disabled = true;
                if (checkLyricsBtn) checkLyricsBtn.disabled = true;
            }

            // Initialize the quiz
            setupEventListeners();
        }

        function showDBStatus(message, type = '') {
            const statusBar = document.getElementById('dbStatus');
            if (statusBar) {
                statusBar.textContent = message;
                statusBar.className = `db-status ${type}`;
                statusBar.style.display = 'block';
            }
        }

        function hideDBStatus() {
            const statusBar = document.getElementById('dbStatus');
            if (statusBar) {
                statusBar.style.display = 'none';
            }
        }
    </script>
</body>

</html>