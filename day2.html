<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Day 2: Are we moving great? </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #a2d2ff 0%, #cdb4db 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 40px 20px;
            overflow-y: auto;
        }
        
        .container {
            width: 100%;
            max-width: 900px;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(162, 210, 255, 0.3);
        }
        
        .header {
            background: linear-gradient(135deg, #ffafcc, #ffc8dd);
            color: white;
            padding: 30px 25px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .progress {
            margin-top: 15px;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .nav-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        
        .back-btn {
            padding: 10px 20px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .day-indicator {
            font-weight: 600;
            color: #ffafcc;
            font-size: 1.1rem;
        }
        
        .db-status {
            background: #e3f2fd;
            border: 2px solid #bbdefb;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 25px;
            color: #1565c0;
            font-weight: 600;
            text-align: center;
            display: none;
        }
        
        .db-status.success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .db-status.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        .progress-bar {
            height: 10px;
            background: #e0e0e0;
            margin-top: 15px;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #ffafcc, #cdb4db);
            transition: width 0.5s ease;
        }
        
        .progress-dots {
            display: flex;
            justify-content: space-between;
            margin-top: -15px;
        }
        
        .dot {
            width: 40px;
            height: 40px;
            background: #e0e0e0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #666;
            z-index: 1;
        }
        
        .dot.active {
            background: #ffafcc;
            color: white;
            transform: scale(1.1);
        }
        
        .dot.completed {
            background: #cdb4db;
            color: white;
        }
        
        .puzzle-content {
            padding: 40px;
            min-height: 600px;
        }
        
        .puzzle {
            display: none;
            animation: fadeIn 0.5s ease;
            padding: 20px 0;
        }
        
        .puzzle.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .puzzle h2 {
            color: #333;
            font-size: 1.8rem;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 30px 0;
        }
        
        .option {
            padding: 25px 20px;
            background: #f8f9fa;
            border: 3px solid #dee2e6;
            border-radius: 15px;
            font-size: 1.3rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #333;
            text-align: center;
        }
        
        .option:hover:not(:disabled) {
            border-color: #ffafcc;
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(255, 175, 204, 0.2);
        }
        
        .option.correct {
            background: #cdb4db;
            color: white;
            border-color: #a2d2ff;
        }
        
        .option.wrong {
            background: #ffafcc;
            color: white;
            border-color: #ffc8dd;
        }
        
        .option:disabled {
            cursor: not-allowed;
            opacity: 0.8;
        }
        
        .text-input {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin: 40px 0;
        }
        
        .text-input input {
            padding: 20px;
            border: 3px solid #dee2e6;
            border-radius: 12px;
            font-size: 1.3rem;
            width: 300px;
            text-align: center;
        }
        
        .text-input button {
            padding: 20px 40px;
            background: #ffafcc;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.3rem;
            cursor: pointer;
            font-weight: 600;
        }
        
        .text-input button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .text-area {
            width: 100%;
            max-width: 600px;
            height: 150px;
            padding: 20px;
            border: 3px solid #dee2e6;
            border-radius: 12px;
            font-size: 1.1rem;
            font-family: inherit;
            resize: none;
            margin: 20px auto;
            display: block;
        }
        
        .text-area:focus {
            outline: none;
            border-color: #ffafcc;
        }
        
        .music-player {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            text-align: center;
        }
        
        .music-player h3 {
            color: #333;
            margin-bottom: 20px;
        }
        
        .play-btn {
            padding: 15px 40px;
            background: #ffafcc;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .play-btn:hover:not(:disabled) {
            background: #cdb4db;
            transform: scale(1.05);
        }
        
        .play-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .timer-display {
            font-size: 1.1rem;
            color: #666;
            margin-top: 15px;
        }
        
        .audio-error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
        }
        
        .feedback {
            padding: 20px;
            margin: 25px auto;
            border-radius: 15px;
            font-size: 1.3rem;
            font-weight: 600;
            text-align: center;
            max-width: 600px;
            display: none;
        }
        
        .feedback.correct {
            background: #d4edda;
            color: #155724;
            border: 3px solid #c3e6cb;
        }
        
        .feedback.incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 3px solid #f5c6cb;
        }
        
        .special-message {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        
        .message-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: scaleIn 0.3s ease;
        }
        
        @keyframes scaleIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .message-box h3 {
            color: #ffafcc;
            font-size: 1.8rem;
            margin-bottom: 20px;
        }
        
        .message-box p {
            color: #333;
            font-size: 1.2rem;
            line-height: 1.6;
            margin-bottom: 30px;
        }
        
        .message-box button {
            padding: 15px 40px;
            background: #ffafcc;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            margin: 10px;
        }
        
        .message-box button.secondary {
            background: #6c757d;
        }
        
        .hint-box {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            color: #856404;
            font-style: italic;
            text-align: center;
        }
        
        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 50px;
            padding: 30px 0;
            border-top: 2px solid #e9ecef;
        }
        
        .nav-btn {
            padding: 18px 35px;
            font-size: 1.2rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .prev-btn {
            background: #6c757d;
            color: white;
        }
        
        .next-btn {
            background: #ffafcc;
            color: white;
        }
        
        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .complete-btn {
            padding: 20px 50px;
            background: #a2d2ff;
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 1.4rem;
            font-weight: 600;
            cursor: pointer;
            display: none;
            margin: 30px auto;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(162, 210, 255, 0.4);
            }
            50% {
                box-shadow: 0 0 0 20px rgba(162, 210, 255, 0);
            }
        }
        
        .footer {
            text-align: center;
            padding: 25px;
            background: #f8f9fa;
            color: #666;
            border-top: 2px solid #e9ecef;
        }
        
        .hint {
            color: #888;
            font-style: italic;
            text-align: center;
            margin: 15px 0;
            font-size: 1.1rem;
        }
        
        .save-status {
            text-align: center;
            color: #28a745;
            font-weight: 600;
            margin: 20px 0;
            font-size: 1.1rem;
            min-height: 24px;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
            flex-direction: column;
            gap: 20px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #ffebee;
            border-top: 5px solid #ffafcc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        
        .final-message {
            background: linear-gradient(135deg, #a2d2ff, #cdb4db);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
            text-align: center;
            font-size: 1.2rem;
            line-height: 1.6;
        }
        
        .romantic-message {
            background: #fff0f5;
            border: 2px solid #ffafcc;
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            text-align: center;
            font-style: italic;
            color: #333;
            line-height: 1.6;
        }
        
        .read-only-mode .option,
        .read-only-mode input,
        .read-only-mode textarea,
        .read-only-mode button:not(.back-btn):not(.nav-btn):not(.player-btn):not(.play-btn) {
            opacity: 0.8;
            cursor: default !important;
        }
        
        .read-only-mode .option:hover {
            transform: none !important;
            box-shadow: none !important;
            border-color: #dee2e6 !important;
        }
        
        .read-only-mode .container {
            border: 3px solid #cdb4db;
        }
        
        .completed-badge {
            background: #cdb4db;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .completed-message {
            background: #d4edda;
            color: #155724;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            font-weight: 600;
            border: 2px solid #c3e6cb;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            .header {
                padding: 20px 15px;
            }
            .header h1 {
                font-size: 1.8rem;
            }
            .puzzle-content {
                padding: 20px;
            }
            .options {
                grid-template-columns: 1fr;
            }
            .option {
                padding: 20px 15px;
                font-size: 1.1rem;
            }
            .navigation {
                flex-direction: column;
                gap: 10px;
            }
            .nav-btn {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Database Status -->
        <div id="dbStatus" class="db-status">üîÑ Checking access...</div>

        <!-- Loading State -->
        <div id="loadingDay" class="loading">
            <div class="spinner"></div>
            <p>Loading Day 2...</p>
        </div>

        <!-- Main Content (hidden initially) -->
        <div id="dayContent" style="display: none;">
            <!-- Header -->
            <div class="header">
                <h1 id="dayTitle">Day 2: Are we moving great?</h1>
                <div class="progress">Question <span id="currentPuzzle">1</span>/5</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-dots">
                    <div class="dot active">1</div>
                    <div class="dot">2</div>
                    <div class="dot">3</div>
                    <div class="dot">4</div>
                    <div class="dot">5</div>
                </div>
            </div>

            <!-- Navigation Bar -->
            <div class="nav-bar">
                <a href="dashboard.html" class="back-btn">‚Üê Back to Dashboard</a>
                <div id="dayIndicator" class="day-indicator">Day 2 of 7</div>
            </div>

            <!-- Puzzle Content -->
            <div class="puzzle-content">
                <!-- Completed Message (only shown in read-only mode) -->
                <div id="completedMessage" class="completed-message" style="display: none;">
                    You've already completed this day! Viewing in read-only mode. Proud of you!
                </div>

                <!-- Puzzle 1 -->
                <div id="puzzle1" class="puzzle active">
                    <h2>What's my shoe size?</h2>
                    <div class="hint-box">
                        üí° Hint: demande-moi üòÅ
                    </div>
                    <div class="text-input">
                        <input type="text" id="shoeSizeInput" placeholder="Enter shoe size" maxlength="4">
                        <button id="checkShoeSize">Submit AnswerüòÆ‚Äçüí®</button>
                    </div>
                    <div id="feedback1" class="feedback"></div>
                </div>

                <!-- Puzzle 2 -->
                <div id="puzzle2" class="puzzle">
                    <h2>Listen to the song snippet üôÉ </h2>
                    <div class="hint-box">
                        üí° Hint: Listen carefully!
                    </div>
                    <div class="music-player">
                        <h3>üéµ Song Snippet</h3>
                        <button id="playSongBtn" class="play-btn">‚ñ∂ Play Song</button>
                        <div class="audio-error" id="audioError"></div>
                        <div class="timer-display" id="timerDisplay" style="display: none;">Time remaining: 7s</div>
                        <p style="margin-top: 20px; color: #666;">What song is this? ü§î </p>
                        <div class="options">
                            <button class="option" data-answer="I'm yours">I'm yours</button>
                            <button class="option" data-answer="Know that you are loved">Know that you are loved</button>
                            <button class="option" data-answer="Can I be him">Can I be him</button>
                            <button class="option" data-answer="Bloom">Bloom</button>
                        </div>
                    </div>
                    <div id="feedback2" class="feedback"></div>
                </div>

                <!-- Puzzle 3 -->
                <div id="puzzle3" class="puzzle">
                    <h2>Do you think I'll be a good husband? ü•≤ </h2>
                    <div class="hint-box">
                        No wrong answer here, just be honest!
                    </div>
                    <div class="options">
                        <button class="option" data-answer="Yes">Yes üíç</button>
                        <button class="option" data-answer="No">No üòî</button>
                    </div>
                    <p class="hint">Why do you think so? (Optional)</p>
                    <textarea class="text-area" id="husbandReason" placeholder="Share your thoughts here... (max 100 words)"></textarea>
                    <div id="feedback3" class="feedback"></div>
                </div>

                <!-- Puzzle 4 -->
                <div id="puzzle4" class="puzzle">
                    <h2>Finish the sentence üôÇ‚Äç‚ÜïÔ∏è </h2>
                    <div class="hint-box">
                        üí°Complete with how you are feeling right now üòù(just one word)
                    </div>
                    <h3 style="text-align: center; margin: 30px 0;">"When I talk to you, I feel ____"</h3>
                    <div class="text-input">
                        <input type="text" id="feelingInput" placeholder="Complete the sentence" maxlength="50">
                        <button id="checkFeeling">Submit</button>
                    </div>
                    <div id="feedback4" class="feedback"></div>
                </div>

                <!-- Puzzle 5 -->
                <div id="puzzle5" class="puzzle">
                    <h2>My dream weekend includes? ü§®</h2>
                    <div class="hint-box">
                        üí° Think about what matters most
                    </div>
                    <div class="options">
                        <button class="option" data-answer="Being with you">Being with you üíï</button>
                        <button class="option" data-answer="Reading together">Reading together üìö</button>
                        <button class="option" data-answer="Gaming">Gaming üéÆ</button>
                        <button class="option" data-answer="Trading">Trading üìà</button>
                    </div>
                    <div id="feedback5" class="feedback"></div>
                </div>

                <!-- Romantic Message Section -->
                <div id="romanticMessage" style="display: none;">
                    <div class="romantic-message">
                        <h3>‚ù§Ô∏èSomething for you‚ù§Ô∏è</h3>
                        <p id="dynamicMessage">Every moment talking to you feels special. The way you laugh, the way you think, the way you make me feel - it's all so precious to me. I admire, respect, and want to build a future with you‚ù§Ô∏è.</p>
                    </div>
                </div>

                <!-- Navigation -->
                <div class="navigation">
                    <button id="prevBtn" class="nav-btn prev-btn" disabled>‚Üê Previous</button>
                    <button id="nextBtn" class="nav-btn next-btn">Next Question ‚Üí</button>
                </div>

                <!-- Save Status -->
                <div id="saveStatus" class="save-status"></div>

                <!-- Complete Button -->
                <button id="completeBtn" class="complete-btn">Complete Day 2 ü•≥</button>
            </div>

            <!-- Footer -->
            <div class="footer">
                <p>Made by Hlakulo (Your husband to be)</p>
            </div>
        </div>
    </div>

    <!-- Special Message Popup -->
    <div id="specialMessage" class="special-message">
        <div class="message-box">
            <h3 id="messageTitle">Special Message! üíï</h3>
            <p id="messageText"></p>
            <button id="closeMessage">Continue</button>
        </div>
    </div>

    <!-- Final Survey Popup -->
    <div id="surveyPopup" class="special-message">
        <div class="message-box">
            <h3>Almost there! Sweetheart üíÅüèΩ‚Äç‚ôÇÔ∏è </h3>
            <p>The game is still under construction but before we finish, do you love this?</p>
            <div style="margin-top: 30px;">
                <button id="surveyYes" class="survey-btn">Yes! üòç</button>
                <button id="surveyNo" class="survey-btn secondary">Not really üòî</button>
            </div>
        </div>
    </div>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // Supabase Configuration (MUST BE SAME AS OTHER PAGES)
        const SUPABASE_URL = 'https://yqxrsigblsalvhndfvvs.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlxeHJzaWdibHNhbHZobmRmdnZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNDUwNjQsImV4cCI6MjA4MDYyMTA2NH0.gsj4ya1LMKNtWGdwhaDa91L81AdOc6E1BcBd2gwXcJc';

        // Global variables
        let supabase;
        let currentUser = null;
        let currentDay = 2;
        let songTimer = null;
        let songPlayed = false;
        let audio = null;
        let isReadOnly = false;

        // Correct answers
        const CORRECT_ANSWERS = {
            1: '6.5',
            2: 'Can I be him',
            3: '', // No wrong answer
            4: '', // No wrong answer, free response
            5: 'Being with you'
        };

        // Special messages
        const MESSAGES = {
            firstCorrect: "That's my girl! ü•π",
            twoConsecutive: "Wow you know me this much? ü•∫",
            wrongFirst: "Nope that's wrong ü•≤",
            wrongSecond: "What? Don't you know me? üôÑ",
            dayComplete: "Day 2 Complete! Next day unlocks soon!",
            songCorrect: "Yes because I'm H.I.M ‚ù§Ô∏èü§£",
            hintReveal: {
                1: "Hint: You can try asking maybe? ",
                2: "Hint: LalalalalalaüòÇ",
                5: "Hint: ayaya üòÇüòÇ, come on üòù"
            }
        };

        // Romantic messages based on user's responses
        const ROMANTIC_MESSAGES = [
            "I find myself thinking about you throughout the day, wondering what you're doing, hoping you're happy. You've become an important part of my life.ü•∫",
        ];

        // Main initialization - SESSIONSTORAGE ONLY
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Day 2: DOM loaded');

            // SIMPLE AUTHENTICATION CHECK - SESSIONSTORAGE ONLY
            await checkAuthentication();
        });

        // SIMPLIFIED AUTHENTICATION CHECK - SESSIONSTORAGE ONLY
        async function checkAuthentication() {
            console.log('Checking authentication...');

            // Check sessionStorage ONLY (will auto-clear when tab closes)
            const sessionData = sessionStorage.getItem('currentUser');

            if (sessionData) {
                try {
                    currentUser = JSON.parse(sessionData);
                    console.log('Found user in sessionStorage:', currentUser.username);

                    console.log('Authentication successful! User:', currentUser.username);

                    // Initialize Supabase
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

                    // Create audio element for song
                    createAudioElement();

                    // Now check Day 2 access
                    await initializeDay();

                } catch (error) {
                    console.error('Error parsing sessionStorage:', error);
                    redirectToLogin();
                }
            } else {
                // No user found
                console.log('NO USER FOUND - Redirecting to login');
                redirectToLogin();
            }
        }

        function redirectToLogin() {
            showDBStatus('‚ùå Please login first!', 'error');
            setTimeout(() => {
                // Clear session data
                sessionStorage.clear();
                window.location.href = 'index.html';
            }, 1500);
        }

        // Create audio element dynamically
        function createAudioElement() {
            audio = new Audio();
            audio.preload = 'auto';

            // Add multiple source formats for compatibility
            const sources = [{
                src: 'assets/songs/day2-song.mp3',
                type: 'audio/mpeg'
            }, {
                src: 'assets/songs/day2-song.m4a',
                type: 'audio/mp4'
            }, {
                src: 'assets/songs/day2-song.ogg',
                type: 'audio/ogg'
            }, {
                src: 'assets/songs/day2-song.wav',
                type: 'audio/wav'
            }];

            sources.forEach(source => {
                const sourceElement = document.createElement('source');
                sourceElement.src = source.src;
                sourceElement.type = source.type;
                audio.appendChild(sourceElement);
            });

            // Add error event listener
            audio.addEventListener('error', function(e) {
                console.error('Audio error:', e);
                const errorMsg = document.getElementById('audioError');
                if (errorMsg) {
                    errorMsg.textContent = "‚ö†Ô∏è Could not load audio file. Please check if assets/songs/day2-song.mp3 exists.";
                    errorMsg.style.display = 'block';
                }
            });

            audio.addEventListener('canplaythrough', function() {
                console.log('Audio is ready to play');
                const playBtn = document.getElementById('playSongBtn');
                if (playBtn) {
                    playBtn.disabled = false;
                }
            });

            // Add to document
            document.body.appendChild(audio);
        }

        async function initializeDay() {
            console.log('Initializing Day 2 for user:', currentUser.username);
            showDBStatus('üîê Checking Day 2 access...');

            try {
                // Check if Day 2 progress exists
                const {
                    data: progress,
                    error
                } = await supabase
                    .from('user_progress')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .eq('day_number', currentDay)
                    .single();

                if (error) {
                    // If no progress found, check if Day 1 is completed
                    if (error.code === 'PGRST116') {
                        console.log('No Day 2 progress found, checking Day 1 completion...');

                        const {
                            data: day1Progress
                        } = await supabase
                            .from('user_progress')
                            .select('completed')
                            .eq('user_id', currentUser.id)
                            .eq('day_number', 1)
                            .single();

                        if (!day1Progress || !day1Progress.completed) {
                            showDBStatus('‚ùå Complete Day 1 first!', 'error');
                            setTimeout(() => {
                                window.location.href = 'dashboard.html';
                            }, 2000);
                            return;
                        }

                        // Create Day 2 progress
                        await createDayProgress();
                    } else {
                        console.error('Error checking progress:', error);
                        throw error;
                    }
                } else {
                    console.log('Day 2 progress found:', progress);

                    if (!progress.unlocked_at && !progress.completed) {
                        showDBStatus('‚ùå Day 2 is locked', 'error');
                        setTimeout(() => {
                            window.location.href = 'dashboard.html';
                        }, 1500);
                        return;
                    }

                    if (progress.completed) {
                        console.log('Day 2 is completed - read-only mode');
                        isReadOnly = true;
                    }
                }

                console.log('Access granted! Read-only:', isReadOnly);
                showDBStatus('‚úÖ Access granted!', 'success');

                // Show content
                setTimeout(() => {
                    hideDBStatus();
                    document.getElementById('loadingDay').style.display = 'none';
                    document.getElementById('dayContent').style.display = 'block';
                    initializeQuiz();
                }, 1000);

            } catch (error) {
                console.error('Error initializing day:', error);
                showDBStatus('‚ùå Error: ' + error.message, 'error');
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 2000);
            }
        }

        async function createDayProgress() {
            const {
                error
            } = await supabase
                .from('user_progress')
                .insert([{
                    user_id: currentUser.id,
                    day_number: currentDay,
                    unlocked_at: new Date().toISOString(),
                    next_unlock_at: null,
                    completed: false,
                    progress: 0,
                    score: 0,
                    answers: {}
                }]);

            if (error) throw error;
        }

        function initializeQuiz() {
            console.log('Initializing Day 2 quiz...');

            // Quiz state
            let currentPuzzle = 1;
            const totalPuzzles = 5;
            const completedPuzzles = new Array(totalPuzzles).fill(false);
            let consecutiveCorrect = 0; // Keep track internally but don't show
            let wrongAttempts = {};

            // DOM Elements
            const currentPuzzleSpan = document.getElementById('currentPuzzle');
            const progressFill = document.getElementById('progressFill');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const completeBtn = document.getElementById('completeBtn');
            const dots = document.querySelectorAll('.dot');
            const specialMessage = document.getElementById('specialMessage');
            const surveyPopup = document.getElementById('surveyPopup');
            const messageText = document.getElementById('messageText');
            const messageTitle = document.getElementById('messageTitle');
            const closeMessage = document.getElementById('closeMessage');
            const romanticMessage = document.getElementById('romanticMessage');
            const dynamicMessage = document.getElementById('dynamicMessage');
            const completedMessage = document.getElementById('completedMessage');

            // Set up read-only mode if day is completed
            if (isReadOnly) {
                setupReadOnlyMode();
            }

            // Function to show specific puzzle
            function showPuzzle(num) {
                console.log('Showing puzzle', num);

                // Hide all puzzles
                for (let i = 1; i <= totalPuzzles; i++) {
                    const puzzle = document.getElementById(`puzzle${i}`);
                    if (puzzle) {
                        puzzle.classList.remove('active');
                    }
                }

                // Show current puzzle
                const currentPuzzleElement = document.getElementById(`puzzle${num}`);
                if (currentPuzzleElement) {
                    currentPuzzleElement.classList.add('active');
                    currentPuzzle = num;
                }

                // Show romantic message after puzzle 5
                if (romanticMessage && !isReadOnly) {
                    if (num === 5) {
                        romanticMessage.style.display = 'block';
                        // Show random romantic message
                        const randomMessage = ROMANTIC_MESSAGES[Math.floor(Math.random() * ROMANTIC_MESSAGES.length)];
                        dynamicMessage.textContent = randomMessage;
                    } else {
                        romanticMessage.style.display = 'none';
                    }
                }

                // Update UI
                updateProgress();
                updateNavigation();
            }

            // Update progress display
            function updateProgress() {
                if (currentPuzzleSpan) currentPuzzleSpan.textContent = currentPuzzle;

                // Calculate progress percentage
                const completedCount = completedPuzzles.filter(c => c).length;
                const progressPercent = ((completedCount + (currentPuzzle - 1)) / totalPuzzles) * 100;
                if (progressFill) progressFill.style.width = `${progressPercent}%`;

                // Update dots
                dots.forEach((dot, index) => {
                    const puzzleNum = index + 1;
                    dot.classList.remove('active', 'completed');

                    if (puzzleNum === currentPuzzle) {
                        dot.classList.add('active');
                    } else if (completedPuzzles[puzzleNum - 1]) {
                        dot.classList.add('completed');
                    }
                });

                // Show/hide complete button
                const allCompleted = completedPuzzles.every(c => c);
                if (completeBtn && !isReadOnly) {
                    if (allCompleted) {
                        completeBtn.style.display = 'block';
                    } else {
                        completeBtn.style.display = 'none';
                    }
                }
            }

            // Update navigation buttons
            function updateNavigation() {
                if (prevBtn) prevBtn.disabled = currentPuzzle === 1;
                if (nextBtn) nextBtn.disabled = currentPuzzle === totalPuzzles;
            }

            // Setup all event listeners
            function setupEventListeners() {
                console.log('Setting up event listeners...');

                // Previous/Next buttons
                if (prevBtn) {
                    prevBtn.addEventListener('click', function() {
                        if (currentPuzzle > 1) {
                            showPuzzle(currentPuzzle - 1);
                        }
                    });
                }

                if (nextBtn) {
                    nextBtn.addEventListener('click', function() {
                        if (currentPuzzle < totalPuzzles) {
                            showPuzzle(currentPuzzle + 1);
                        }
                    });
                }

                // Complete button (only in active mode)
                if (completeBtn && !isReadOnly) {
                    completeBtn.addEventListener('click', function() {
                        showSurveyPopup();
                    });
                }

                // Close message button
                if (closeMessage) {
                    closeMessage.addEventListener('click', function() {
                        specialMessage.style.display = 'none';

                        // If day is complete, redirect to dashboard
                        if (completedPuzzles.every(c => c) && !isReadOnly) {
                            completeDay();
                        }
                    });
                }

                // Survey buttons (only in active mode)
                if (!isReadOnly) {
                    document.getElementById('surveyYes').addEventListener('click', function() {
                        surveyPopup.style.display = 'none';
                        showSpecialMessage("The countdown for the next day starts now! ‚ù§Ô∏èüôÇ‚Äç‚ÜïÔ∏è ");
                        setTimeout(() => {
                            completeDay();
                        }, 2000);
                    });

                    document.getElementById('surveyNo').addEventListener('click', function() {
                        surveyPopup.style.display = 'none';
                        showSpecialMessage("Still the countdown for the next day starts but please let me know what's missing? üí≠");
                        setTimeout(() => {
                            completeDay();
                        }, 3000);
                    });
                }

                // Load saved answers first
                loadSavedAnswers().then(savedAnswers => {
                    console.log('Loaded saved answers:', savedAnswers);
                    if (savedAnswers && savedAnswers.length > 0) {
                        restoreProgress(savedAnswers);
                        // Force update the progress display
                        updateProgress();
                    }

                    // Now setup each puzzle (only if not read-only)
                    if (!isReadOnly) {
                        setupPuzzle1();
                        setupPuzzle2();
                        setupPuzzle3();
                        setupPuzzle4();
                        setupPuzzle5();
                    } else {
                        // In read-only mode, still allow audio to play
                        setupAudioForReadOnly();
                    }
                });
            }

            // Setup Puzzle 1 (Shoe size)
            function setupPuzzle1() {
                const shoeSizeInput = document.getElementById('shoeSizeInput');
                const checkShoeSize = document.getElementById('checkShoeSize');

                if (!shoeSizeInput || !checkShoeSize) {
                    console.error('Puzzle 1 elements not found');
                    return;
                }

                // Initialize wrong attempts counter
                if (!wrongAttempts[1]) {
                    wrongAttempts[1] = 0;
                }

                checkShoeSize.addEventListener('click', async function() {
                    const userAnswer = shoeSizeInput.value.trim();
                    if (!userAnswer) {
                        showFeedback(1, false, 0);
                        return;
                    }

                    // Normalize the answer (accept 6.5, 6,5, 6.5 etc)
                    const normalizedAnswer = userAnswer.replace(',', '.').toLowerCase();
                    const isCorrect = normalizedAnswer === CORRECT_ANSWERS[1].toLowerCase();

                    if (isCorrect) {
                        // Correct answer
                        shoeSizeInput.classList.add('correct');
                        shoeSizeInput.disabled = true;
                        checkShoeSize.disabled = true;
                        completedPuzzles[0] = true;

                        // Update consecutive counter (internally only)
                        consecutiveCorrect++;

                        // Save answer to Supabase
                        await saveAnswerToSupabase(1, {
                            answer: userAnswer,
                            correct: true,
                            attempts: 1
                        });

                        // Update progress
                        updateProgress();
                        showFeedback(1, true, 1);
                    } else {
                        // Wrong answer
                        shoeSizeInput.classList.add('wrong');

                        // Reset consecutive counter
                        consecutiveCorrect = 0;

                        // Track wrong attempts
                        wrongAttempts[1] = (wrongAttempts[1] || 0) + 1;

                        // Show hint after 2 wrong attempts
                        if (wrongAttempts[1] === 2) {
                            showHint(1);
                        }

                        // Save attempt to Supabase
                        await saveAnswerToSupabase(1, {
                            answer: userAnswer,
                            correct: false,
                            attempts: 1
                        });

                        // Clear input after delay
                        setTimeout(() => {
                            shoeSizeInput.classList.remove('wrong');
                            shoeSizeInput.value = '';
                        }, 1000);

                        showFeedback(1, false, wrongAttempts[1]);
                    }
                });

                // Enter key support
                shoeSizeInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        checkShoeSize.click();
                    }
                });
            }

            // Setup Puzzle 2 (Song)
            function setupPuzzle2() {
                const playSongBtn = document.getElementById('playSongBtn');
                const timerDisplay = document.getElementById('timerDisplay');
                const audioError = document.getElementById('audioError');
                const options = document.querySelectorAll('#puzzle2 .option');

                if (!playSongBtn) {
                    console.error('Puzzle 2 elements not found');
                    return;
                }

                // Initialize wrong attempts counter
                if (!wrongAttempts[2]) {
                    wrongAttempts[2] = 0;
                }

                // Song playback
                playSongBtn.addEventListener('click', async function() {
                    if (songPlayed && this.textContent !== "Replay Song") return;

                    try {
                        // Reset audio
                        audio.currentTime = 0;

                        // Show loading state
                        playSongBtn.disabled = true;
                        playSongBtn.textContent = "Loading...";
                        if (timerDisplay) {
                            timerDisplay.textContent = "Loading audio...";
                            timerDisplay.style.display = 'block';
                        }
                        if (audioError) {
                            audioError.style.display = 'none';
                        }

                        // Play audio
                        await audio.play();

                        // Update UI
                        playSongBtn.textContent = "Playing... üôÇ‚Äç‚ÜïÔ∏è";

                        // Show timer
                        let timeLeft = 7;
                        if (timerDisplay) {
                            timerDisplay.textContent = `Time remaining: ${timeLeft}s`;
                        }

                        // Clear any existing timer
                        if (songTimer) clearInterval(songTimer);

                        songTimer = setInterval(() => {
                            timeLeft--;
                            if (timerDisplay) {
                                timerDisplay.textContent = `Time remaining: ${timeLeft}s`;
                            }

                            if (timeLeft <= 0) {
                                clearInterval(songTimer);
                                if (timerDisplay) {
                                    timerDisplay.textContent = "Song finished! üòÇ ";
                                }
                                audio.pause();
                                songPlayed = true;
                                playSongBtn.textContent = "Replay? üôÇ‚Äç‚ÜïÔ∏è";
                                playSongBtn.disabled = false;

                                // Enable options after song plays
                                if (!isReadOnly) {
                                    options.forEach(option => {
                                        option.disabled = false;
                                    });
                                }
                            }
                        }, 1000);

                        // Auto-pause after 7 seconds
                        setTimeout(() => {
                            if (audio && !audio.paused) {
                                audio.pause();
                            }
                        }, 7000);

                    } catch (error) {
                        console.error('Error playing audio:', error);
                        showSaveStatus("‚ùå Couldn't play audio. Check browser permissions and file path.", 'error');
                        if (audioError) {
                            audioError.textContent = "Error playing audio. Make sure assets/songs/day2-song.mp3 exists.";
                            audioError.style.display = 'block';
                        }
                        playSongBtn.disabled = false;
                        playSongBtn.textContent = "Play Song üôÇ‚Äç‚ÜïÔ∏è";
                        if (timerDisplay) {
                            timerDisplay.textContent = "Click to try again";
                        }
                    }
                });

                // Song options
                options.forEach(option => {
                    option.disabled = true; // Disabled until song plays

                    option.addEventListener('click', async function() {
                        if (this.disabled || !songPlayed) return;

                        const userAnswer = this.dataset.answer;
                        const isCorrect = userAnswer === CORRECT_ANSWERS[2];

                        if (isCorrect) {
                            // Correct answer
                            this.classList.add('correct');
                            completedPuzzles[1] = true;
                            options.forEach(opt => opt.disabled = true);

                            // Update consecutive counter (internally only)
                            consecutiveCorrect++;

                            // Save answer to Supabase
                            await saveAnswerToSupabase(2, {
                                answer: userAnswer,
                                correct: true,
                                attempts: 1
                            });

                            // Update progress
                            updateProgress();
                            showFeedback(2, true, 1);

                            // Show special message for correct song
                            setTimeout(() => {
                                showSpecialMessage(MESSAGES.songCorrect);
                            }, 500);
                        } else {
                            // Wrong answer
                            this.classList.add('wrong üò≠');
                            this.disabled = true;

                            // Reset consecutive counter
                            consecutiveCorrect = 0;

                            // Track wrong attempts
                            wrongAttempts[2] = (wrongAttempts[2] || 0) + 1;

                            // Show hint after 2 wrong attempts
                            if (wrongAttempts[2] === 2) {
                                showHint(2);
                            }

                            // Save attempt to Supabase
                            await saveAnswerToSupabase(2, {
                                answer: userAnswer,
                                correct: false,
                                attempts: 1
                            });

                            showFeedback(2, false, wrongAttempts[2]);
                        }
                    });
                });
            }

            // Setup audio for read-only mode
            function setupAudioForReadOnly() {
                const playSongBtn = document.getElementById('playSongBtn');
                const timerDisplay = document.getElementById('timerDisplay');
                const audioError = document.getElementById('audioError');

                if (!playSongBtn) return;

                playSongBtn.addEventListener('click', async function() {
                    try {
                        // Reset audio
                        audio.currentTime = 0;

                        // Show loading state
                        playSongBtn.disabled = true;
                        playSongBtn.textContent = "Loading...";
                        if (timerDisplay) {
                            timerDisplay.textContent = "Loading audio...";
                            timerDisplay.style.display = 'block';
                        }
                        if (audioError) {
                            audioError.style.display = 'none';
                        }

                        // Play audio
                        await audio.play();

                        // Update UI
                        playSongBtn.textContent = "Playing... üôÇ‚Äç‚ÜïÔ∏è";

                        // Show timer
                        let timeLeft = 7;
                        if (timerDisplay) {
                            timerDisplay.textContent = `Time remaining: ${timeLeft}s`;
                        }

                        // Clear any existing timer
                        if (songTimer) clearInterval(songTimer);

                        songTimer = setInterval(() => {
                            timeLeft--;
                            if (timerDisplay) {
                                timerDisplay.textContent = `Time remaining: ${timeLeft}s`;
                            }

                            if (timeLeft <= 0) {
                                clearInterval(songTimer);
                                if (timerDisplay) {
                                    timerDisplay.textContent = "Song finished! üòÇ ";
                                }
                                audio.pause();
                                songPlayed = true;
                                playSongBtn.textContent = "Replay? üôÇ‚Äç‚ÜïÔ∏è";
                                playSongBtn.disabled = false;
                            }
                        }, 1000);

                        // Auto-pause after 7 seconds
                        setTimeout(() => {
                            if (audio && !audio.paused) {
                                audio.pause();
                            }
                        }, 7000);

                    } catch (error) {
                        console.error('Error playing audio:', error);
                        showSaveStatus("‚ùå Couldn't play audio. Check browser permissions and file path.", 'error');
                        if (audioError) {
                            audioError.textContent = "Error playing audio. Make sure assets/songs/day2-song.mp3 exists.";
                            audioError.style.display = 'block';
                        }
                        playSongBtn.disabled = false;
                        playSongBtn.textContent = "Play Song üôÇ‚Äç‚ÜïÔ∏è";
                        if (timerDisplay) {
                            timerDisplay.textContent = "Click to try again";
                        }
                    }
                });
            }

            // Setup Puzzle 3 (Husband question)
            function setupPuzzle3() {
                const options = document.querySelectorAll('#puzzle3 .option');
                const husbandReason = document.getElementById('husbandReason');

                if (!options.length) {
                    console.error('Puzzle 3 elements not found');
                    return;
                }

                options.forEach(option => {
                    option.addEventListener('click', async function() {
                        const userAnswer = this.dataset.answer;

                        // Mark as completed (no wrong answer)
                        this.classList.add('correct üôÇ‚Äç‚ÜïÔ∏è');
                        completedPuzzles[2] = true;
                        options.forEach(opt => opt.disabled = true);

                        // Save answer to Supabase
                        await saveAnswerToSupabase(3, {
                            answer: userAnswer,
                            correct: true, // Always correct for this question
                            attempts: 1,
                            reason: husbandReason ? husbandReason.value : ''
                        });

                        // Update progress
                        updateProgress();
                        showFeedback(3, true, 1);
                    });
                });

                // Save reason when typing
                if (husbandReason) {
                    husbandReason.addEventListener('input', function() {
                        // Auto-save reason to Supabase
                        saveAnswerReason(3, this.value);
                    });
                }
            }

            // Setup Puzzle 4 (Feeling question)
            function setupPuzzle4() {
                const feelingInput = document.getElementById('feelingInput');
                const checkFeeling = document.getElementById('checkFeeling');

                if (!feelingInput || !checkFeeling) {
                    console.error('Puzzle 4 elements not found');
                    return;
                }

                checkFeeling.addEventListener('click', async function() {
                    const userAnswer = feelingInput.value.trim();
                    if (!userAnswer) {
                        showFeedback(4, false, 0);
                        return;
                    }

                    // Mark as completed (no wrong answer, but must have input)
                    feelingInput.classList.add('correct üôÇ‚Äç‚ÜïÔ∏è');
                    feelingInput.disabled = true;
                    checkFeeling.disabled = true;
                    completedPuzzles[3] = true;

                    // Save answer to Supabase
                    await saveAnswerToSupabase(4, {
                        answer: userAnswer,
                        correct: true, // Always correct for this question
                        attempts: 1
                    });

                    // Update progress
                    updateProgress();
                    showFeedback(4, true, 1);
                });

                // Enter key support
                feelingInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        checkFeeling.click();
                    }
                });
            }

            // Setup Puzzle 5 (Weekend question)
            function setupPuzzle5() {
                const options = document.querySelectorAll('#puzzle5 .option');

                if (!options.length) {
                    console.error('Puzzle 5 elements not found');
                    return;
                }

                // Initialize wrong attempts counter
                if (!wrongAttempts[5]) {
                    wrongAttempts[5] = 0;
                }

                options.forEach(option => {
                    option.addEventListener('click', async function() {
                        const userAnswer = this.dataset.answer;
                        const isCorrect = userAnswer === CORRECT_ANSWERS[5];

                        if (isCorrect) {
                            // Correct answer
                            this.classList.add('correct üôÇ‚Äç‚ÜïÔ∏è');
                            completedPuzzles[4] = true;
                            options.forEach(opt => opt.disabled = true);

                            // Update consecutive counter (internally only)
                            consecutiveCorrect++;

                            // Save answer to Supabase
                            await saveAnswerToSupabase(5, {
                                answer: userAnswer,
                                correct: true,
                                attempts: 1
                            });

                            // Update progress
                            updateProgress();
                            showFeedback(5, true, 1);
                        } else {
                            // Wrong answer
                            this.classList.add('wrong');
                            this.disabled = true;

                            // Reset consecutive counter
                            consecutiveCorrect = 0;

                            // Track wrong attempts
                            wrongAttempts[5] = (wrongAttempts[5] || 0) + 1;

                            // Show hint after 2 wrong attempts
                            if (wrongAttempts[5] === 2) {
                                showHint(5);
                            }

                            // Save attempt to Supabase
                            await saveAnswerToSupabase(5, {
                                answer: userAnswer,
                                correct: false,
                                attempts: 1
                            });

                            showFeedback(5, false, wrongAttempts[5]);
                        }
                    });
                });
            }

            // Show feedback message
            function showFeedback(puzzleNum, isCorrect, attempt) {
                const feedbackElement = document.getElementById(`feedback${puzzleNum}`);
                if (!feedbackElement) return;

                if (isCorrect && !isReadOnly) {
                    feedbackElement.textContent = "Good üòÖ"; // Changed from "‚úÖ Correct! Well done!"
                    feedbackElement.className = 'feedback correct';
                    feedbackElement.style.display = 'block';

                    // Auto-hide after 2 seconds for active mode
                    setTimeout(() => {
                        feedbackElement.style.display = 'none';
                    }, 2000);
                } else if (!isCorrect && !isReadOnly) {
                    let message;
                    if (attempt === 1) {
                        message = MESSAGES.wrongFirst;
                    } else if (attempt === 2) {
                        message = MESSAGES.wrongSecond;
                    } else {
                        message = "Try again! üò¢";
                    }

                    feedbackElement.textContent = message;
                    feedbackElement.className = 'feedback incorrect';
                    feedbackElement.style.display = 'block';

                    // Auto-hide after 3 seconds
                    setTimeout(() => {
                        feedbackElement.style.display = 'none';
                    }, 3000);
                }
                // In read-only mode, don't show any feedback messages
            }

            // Show special message popup
            function showSpecialMessage(message) {
                if (!messageText || !messageTitle) return;

                messageText.textContent = message;
                messageTitle.textContent = "Special Message! üíï";
                if (specialMessage) {
                    specialMessage.style.display = 'flex';
                }
            }

            // Show survey popup
            function showSurveyPopup() {
                if (surveyPopup) {
                    surveyPopup.style.display = 'flex';
                }
            }

            // Show hint after 2 wrong attempts
            function showHint(puzzleNum) {
                const hint = MESSAGES.hintReveal[puzzleNum];
                if (hint) {
                    const feedbackElement = document.getElementById(`feedback${puzzleNum}`);
                    if (feedbackElement && !isReadOnly) {
                        feedbackElement.textContent = `üí° ${hint}`;
                        feedbackElement.className = 'feedback incorrect';
                        feedbackElement.style.display = 'block';

                        // Auto-hide after 5 seconds
                        setTimeout(() => {
                            feedbackElement.style.display = 'none';
                        }, 5000);
                    }
                }
            }

            // Save answer to Supabase
            async function saveAnswerToSupabase(puzzleNumber, answerData) {
                try {
                    const {
                        error
                    } = await supabase
                        .from('day_answers')
                        .upsert({
                            user_id: currentUser.id,
                            day_number: currentDay,
                            puzzle_number: puzzleNumber,
                            answer: answerData.answer,
                            correct: answerData.correct,
                            attempts: answerData.attempts,
                            reason: answerData.reason || null,
                            answered_at: new Date().toISOString()
                        }, {
                            onConflict: 'user_id,day_number,puzzle_number'
                        });

                    if (error) throw error;

                    // Update progress in Supabase
                    await updateProgressInSupabase();

                    showSaveStatus('‚úÖ Answer saved!');

                } catch (error) {
                    console.error('Error saving answer:', error);
                    showSaveStatus('‚ùå Failed to save', 'error');
                }
            }

            // Save answer reason separately
            async function saveAnswerReason(puzzleNumber, reason) {
                try {
                    const {
                        error
                    } = await supabase
                        .from('day_answers')
                        .update({
                            reason: reason
                        })
                        .eq('user_id', currentUser.id)
                        .eq('day_number', currentDay)
                        .eq('puzzle_number', puzzleNumber);

                    if (error) throw error;
                } catch (error) {
                    console.error('Error saving reason:', error);
                }
            }

            // Update progress in Supabase
            async function updateProgressInSupabase() {
                try {
                    // Count completed puzzles
                    const {
                        data: answers,
                        error: answersError
                    } = await supabase
                        .from('day_answers')
                        .select('correct')
                        .eq('user_id', currentUser.id)
                        .eq('day_number', currentDay);

                    if (answersError) throw answersError;

                    const completedCount = answers.filter(a => a.correct).length;
                    const isComplete = completedCount === 5;

                    // Update progress
                    const {
                        error: progressError
                    } = await supabase
                        .from('user_progress')
                        .update({
                            progress: completedCount,
                            completed: isComplete,
                            score: completedCount * 20,
                            completed_at: isComplete ? new Date().toISOString() : null
                        })
                        .eq('user_id', currentUser.id)
                        .eq('day_number', currentDay);

                    if (progressError) throw progressError;

                    if (isComplete && !isReadOnly) {
                        // Start countdown for next day
                        await startNextDayCountdown();
                    }

                } catch (error) {
                    console.error('Error updating progress:', error);
                }
            }

            // Start countdown for next day
            async function startNextDayCountdown() {
                try {
                    const nextDay = currentDay + 1;
                    if (nextDay > 7) return;

                    // 24 hours for Jessica (girlfriend), 3 minutes for Hlakulo (test)
                    const isJessica = currentUser.is_jessica;
                    const unlockDuration = isJessica ? 24 * 60 * 60 * 1000 : 3 * 60 * 1000;
                    const nextUnlockAt = new Date(Date.now() + unlockDuration).toISOString();

                    console.log(`Countdown for Day ${nextDay}: ${isJessica ? '24 hours (Jessica real)' : '3 minutes (Hlakulo test)'}`);

                    // Create or update next day progress
                    const {
                        error
                    } = await supabase
                        .from('user_progress')
                        .upsert({
                            user_id: currentUser.id,
                            day_number: nextDay,
                            next_unlock_at: nextUnlockAt,
                            unlocked_at: null,
                            completed: false,
                            progress: 0,
                            score: 0
                        }, {
                            onConflict: 'user_id,day_number'
                        });

                    if (error) throw error;

                } catch (error) {
                    console.error('Error starting countdown:', error);
                }
            }

            // Load saved answers from Supabase
            async function loadSavedAnswers() {
                try {
                    const {
                        data: answers,
                        error
                    } = await supabase
                        .from('day_answers')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .eq('day_number', currentDay)
                        .order('puzzle_number', {
                            ascending: true
                        });

                    if (error) throw error;

                    return answers || [];

                } catch (error) {
                    console.error('Error loading saved answers:', error);
                    return [];
                }
            }

            // Restore progress from saved answers
            function restoreProgress(savedAnswers) {
                console.log('Restoring progress from:', savedAnswers);

                if (!savedAnswers || savedAnswers.length === 0) {
                    console.log('No saved answers found');
                    return;
                }

                // Mark all puzzles as completed by default in read-only mode
                if (isReadOnly) {
                    for (let i = 0; i < totalPuzzles; i++) {
                        completedPuzzles[i] = true;
                    }
                }

                savedAnswers.forEach(answer => {
                    const puzzleNum = answer.puzzle_number;

                    if (answer.correct) {
                        completedPuzzles[puzzleNum - 1] = true;

                        // Restore puzzle 1 (shoe size)
                        if (puzzleNum === 1) {
                            const shoeSizeInput = document.getElementById('shoeSizeInput');
                            const checkShoeSize = document.getElementById('checkShoeSize');
                            if (shoeSizeInput) {
                                shoeSizeInput.value = answer.answer;
                                shoeSizeInput.classList.add('correct');
                                shoeSizeInput.disabled = true;
                            }
                            if (checkShoeSize) checkShoeSize.disabled = true;
                        }
                        // Restore puzzle 2 (song)
                        else if (puzzleNum === 2) {
                            const options = document.querySelectorAll('#puzzle2 .option');
                            const playSongBtn = document.getElementById('playSongBtn');
                            options.forEach(option => {
                                option.disabled = true;
                                if (option.dataset.answer === answer.answer) {
                                    option.classList.add('correct');
                                }
                            });
                            if (playSongBtn) {
                                // In read-only mode, keep play button enabled
                                if (!isReadOnly) {
                                    playSongBtn.disabled = true;
                                    playSongBtn.textContent = "Song Played";
                                } else {
                                    playSongBtn.disabled = false;
                                    playSongBtn.textContent = "‚ñ∂ Play Song (7 seconds)";
                                }
                            }
                            songPlayed = true;
                        }
                        // Restore puzzle 3 (husband question)
                        else if (puzzleNum === 3) {
                            const options = document.querySelectorAll('#puzzle3 .option');
                            const husbandReason = document.getElementById('husbandReason');
                            options.forEach(option => {
                                option.disabled = true;
                                if (option.dataset.answer === answer.answer) {
                                    option.classList.add('correct');
                                }
                            });
                            if (husbandReason && answer.reason) {
                                husbandReason.value = answer.reason;
                                if (isReadOnly) husbandReason.disabled = true;
                            }
                        }
                        // Restore puzzle 4 (feeling question)
                        else if (puzzleNum === 4) {
                            const feelingInput = document.getElementById('feelingInput');
                            const checkFeeling = document.getElementById('checkFeeling');
                            if (feelingInput) {
                                feelingInput.value = answer.answer;
                                feelingInput.classList.add('correct');
                                feelingInput.disabled = true;
                            }
                            if (checkFeeling) checkFeeling.disabled = true;
                        }
                        // Restore puzzle 5 (weekend question)
                        else if (puzzleNum === 5) {
                            const options = document.querySelectorAll('#puzzle5 .option');
                            options.forEach(option => {
                                option.disabled = true;
                                if (option.dataset.answer === answer.answer) {
                                    option.classList.add('correct');
                                }
                            });
                        }

                        // Don't show feedback in read-only mode
                        if (!isReadOnly) {
                            const feedbackElement = document.getElementById(`feedback${puzzleNum}`);
                            if (feedbackElement) {
                                feedbackElement.textContent = "Good";
                                feedbackElement.className = 'feedback correct';
                                feedbackElement.style.display = 'block';

                                // Hide after 2 seconds in active mode
                                setTimeout(() => {
                                    feedbackElement.style.display = 'none';
                                }, 2000);
                            }
                        }
                    } else {
                        // For wrong answers in read-only mode, still show the attempt
                        if (isReadOnly) {
                            if (puzzleNum === 2 || puzzleNum === 5) {
                                const options = document.querySelectorAll(`#puzzle${puzzleNum} .option`);
                                options.forEach(option => {
                                    option.disabled = true;
                                    if (option.dataset.answer === answer.answer) {
                                        option.classList.add('wrong');
                                    }
                                });
                            }
                        }
                    }
                });

                console.log('Completed puzzles after restore:', completedPuzzles);
            }

            // Complete the day
            async function completeDay() {
                try {
                    // Mark day as complete in Supabase
                    const {
                        error
                    } = await supabase
                        .from('user_progress')
                        .update({
                            completed: true,
                            completed_at: new Date().toISOString()
                        })
                        .eq('user_id', currentUser.id)
                        .eq('day_number', currentDay);

                    if (error) throw error;

                    // Redirect to dashboard after delay
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 500);

                } catch (error) {
                    console.error('Error completing day:', error);
                }
            }

            // Show save status
            function showSaveStatus(message, type = 'success') {
                const status = document.getElementById('saveStatus');
                if (status) {
                    status.textContent = message;
                    status.style.color = type === 'success' ? '#28a745' : '#dc3545';
                    status.style.display = 'block';

                    setTimeout(() => {
                        status.style.display = 'none';
                    }, 3000);
                }
            }

            // Function to set up read-only mode
            function setupReadOnlyMode() {
                console.log('Setting up read-only mode...');

                // Update header
                const dayTitle = document.getElementById('dayTitle');
                if (dayTitle) {
                    dayTitle.innerHTML = 'Day 2: Completed ‚úÖ <span class="completed-badge">READ ONLY</span>';
                }

                // Update day indicator
                const dayIndicator = document.getElementById('dayIndicator');
                if (dayIndicator) {
                    dayIndicator.textContent = 'Day 2 of 7 (Completed)';
                }

                // Show completed message
                if (completedMessage) {
                    completedMessage.style.display = 'block';
                }

                // Hide complete button
                if (completeBtn) {
                    completeBtn.style.display = 'none';
                }

                // Add read-only class to body
                document.body.classList.add('read-only-mode');

                // Disable all interactive elements except navigation and audio buttons
                const allOptions = document.querySelectorAll('.option');
                allOptions.forEach(option => {
                    option.disabled = true;
                    option.style.cursor = 'default';
                });

                const allInputs = document.querySelectorAll('input, textarea, button:not(.back-btn):not(.nav-btn):not(.play-btn)');
                allInputs.forEach(input => {
                    input.disabled = true;
                });

                // Load and display saved answers immediately
                loadSavedAnswers().then(savedAnswers => {
                    console.log('Loading answers for read-only mode:', savedAnswers);
                    if (savedAnswers && savedAnswers.length > 0) {
                        restoreProgress(savedAnswers);
                        // Force update the progress display
                        updateProgress();
                    } else {
                        console.log('No saved answers found for read-only mode');
                    }
                });
            }

            // Initialize the quiz
            showPuzzle(1);
            setupEventListeners();
        }

        function showDBStatus(message, type = '') {
            const statusBar = document.getElementById('dbStatus');
            if (statusBar) {
                statusBar.textContent = message;
                statusBar.className = `db-status ${type}`;
                statusBar.style.display = 'block';
            }
        }

        function hideDBStatus() {
            const statusBar = document.getElementById('dbStatus');
            if (statusBar) {
                statusBar.style.display = 'none';
            }
        }
    </script>
</body>

</html>