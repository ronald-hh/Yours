<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Day 3: Deep Connections</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #b5ead7 0%, #ffdac1 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 40px 20px;
            overflow-y: auto;
        }
        
        .container {
            width: 100%;
            max-width: 900px;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(181, 234, 215, 0.3);
        }
        
        .header {
            background: linear-gradient(135deg, #b5ead7, #ffdac1);
            color: white;
            padding: 30px 25px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .progress {
            margin-top: 15px;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .nav-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        
        .back-btn {
            padding: 10px 20px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .day-indicator {
            font-weight: 600;
            color: #b5ead7;
            font-size: 1.1rem;
        }
        
        .db-status {
            background: #e3f2fd;
            border: 2px solid #bbdefb;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 25px;
            color: #1565c0;
            font-weight: 600;
            text-align: center;
            display: none;
        }
        
        .db-status.success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .db-status.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        .progress-bar {
            height: 10px;
            background: #e0e0e0;
            margin-top: 15px;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #b5ead7, #ffdac1);
            transition: width 0.5s ease;
        }
        
        .progress-dots {
            display: flex;
            justify-content: space-between;
            margin-top: -15px;
        }
        
        .dot {
            width: 40px;
            height: 40px;
            background: #e0e0e0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #666;
            z-index: 1;
        }
        
        .dot.active {
            background: #b5ead7;
            color: white;
            transform: scale(1.1);
        }
        
        .dot.completed {
            background: #ffdac1;
            color: white;
        }
        
        .puzzle-content {
            padding: 40px;
            min-height: 600px;
        }
        
        .puzzle {
            display: none;
            animation: fadeIn 0.5s ease;
            padding: 20px 0;
        }
        
        .puzzle.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .puzzle h2 {
            color: #333;
            font-size: 1.8rem;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 30px 0;
        }
        
        .option {
            padding: 25px 20px;
            background: #f8f9fa;
            border: 3px solid #dee2e6;
            border-radius: 15px;
            font-size: 1.3rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #333;
            text-align: center;
        }
        
        .option:hover:not(:disabled) {
            border-color: #b5ead7;
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(181, 234, 215, 0.2);
        }
        
        .option.correct {
            background: #b5ead7;
            color: white;
            border-color: #ffdac1;
        }
        
        .option.wrong {
            background: #ffdac1;
            color: white;
            border-color: #ffdac1;
        }
        
        .option:disabled {
            cursor: not-allowed;
            opacity: 0.8;
        }
        
        .text-input {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin: 40px 0;
        }
        
        .text-input input {
            padding: 20px;
            border: 3px solid #dee2e6;
            border-radius: 12px;
            font-size: 1.3rem;
            width: 300px;
            text-align: center;
        }
        
        .text-input button {
            padding: 20px 40px;
            background: #b5ead7;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.3rem;
            cursor: pointer;
            font-weight: 600;
        }
        
        .text-input button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .text-area {
            width: 100%;
            max-width: 600px;
            height: 150px;
            padding: 20px;
            border: 3px solid #dee2e6;
            border-radius: 12px;
            font-size: 1.1rem;
            font-family: inherit;
            resize: none;
            margin: 20px auto;
            display: block;
        }
        
        .text-area:focus {
            outline: none;
            border-color: #b5ead7;
        }
        
        .nickname-message {
            background: #f0f9ff;
            border: 2px solid #b5ead7;
            border-radius: 12px;
            padding: 20px;
            margin: 25px 0;
            text-align: center;
            font-style: italic;
            color: #333;
            line-height: 1.6;
            display: none;
        }
        
        .scramble-letters {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 40px 0;
            padding: 0 10px;
        }
        
        .scramble-letter {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #b5ead7, #ffdac1);
            color: white;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: bold;
            box-shadow: 0 8px 20px rgba(181, 234, 215, 0.3);
            transform: rotate(5deg);
        }
        
        .scramble-letter:nth-child(1) {
            transform: rotate(-15deg);
        }
        
        .scramble-letter:nth-child(2) {
            transform: rotate(10deg);
        }
        
        .scramble-letter:nth-child(3) {
            transform: rotate(-5deg);
        }
        
        .scramble-letter:nth-child(4) {
            transform: rotate(15deg);
        }
        
        .scramble-letter:nth-child(5) {
            transform: rotate(-10deg);
        }
        
        .word-input {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 40px 0;
        }
        
        .word-input input {
            width: 70px;
            height: 70px;
            border: 3px solid #dee2e6;
            border-radius: 12px;
            font-size: 2.5rem;
            font-weight: bold;
            text-align: center;
            text-transform: uppercase;
        }
        
        .word-input input:disabled {
            background: #f8f9fa;
        }
        
        .check-btn {
            padding: 20px 40px;
            background: #b5ead7;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.3rem;
            cursor: pointer;
            font-weight: 600;
            display: block;
            margin: 20px auto;
        }
        
        .check-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .feedback {
            padding: 20px;
            margin: 25px auto;
            border-radius: 15px;
            font-size: 1.3rem;
            font-weight: 600;
            text-align: center;
            max-width: 600px;
            display: none;
        }
        
        .feedback.correct {
            background: #d4edda;
            color: #155724;
            border: 3px solid #c3e6cb;
        }
        
        .feedback.incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 3px solid #f5c6cb;
        }
        
        .special-message {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        
        .message-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: scaleIn 0.3s ease;
        }
        
        @keyframes scaleIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .message-box h3 {
            color: #b5ead7;
            font-size: 1.8rem;
            margin-bottom: 20px;
        }
        
        .message-box p {
            color: #333;
            font-size: 1.2rem;
            line-height: 1.6;
            margin-bottom: 30px;
        }
        
        .message-box button {
            padding: 15px 40px;
            background: #b5ead7;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
        }
        
        .hint-box {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            color: #856404;
            font-style: italic;
            text-align: center;
        }
        
        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 50px;
            padding: 30px 0;
            border-top: 2px solid #e9ecef;
        }
        
        .nav-btn {
            padding: 18px 35px;
            font-size: 1.2rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .prev-btn {
            background: #6c757d;
            color: white;
        }
        
        .next-btn {
            background: #b5ead7;
            color: white;
        }
        
        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .complete-btn {
            padding: 20px 50px;
            background: #ffdac1;
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 1.4rem;
            font-weight: 600;
            cursor: pointer;
            display: none;
            margin: 30px auto;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(255, 218, 193, 0.4);
            }
            50% {
                box-shadow: 0 0 0 20px rgba(255, 218, 193, 0);
            }
        }
        
        .footer {
            text-align: center;
            padding: 25px;
            background: #f8f9fa;
            color: #666;
            border-top: 2px solid #e9ecef;
        }
        
        .hint {
            color: #888;
            font-style: italic;
            text-align: center;
            margin: 15px 0;
            font-size: 1.1rem;
        }
        
        .save-status {
            text-align: center;
            color: #28a745;
            font-weight: 600;
            margin: 20px 0;
            font-size: 1.1rem;
            min-height: 24px;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
            flex-direction: column;
            gap: 20px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f0f9ff;
            border-top: 5px solid #b5ead7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        
        .read-only-mode .option,
        .read-only-mode input,
        .read-only-mode textarea,
        .read-only-mode button:not(.back-btn):not(.nav-btn):not(.player-btn):not(.play-btn) {
            opacity: 0.8;
            cursor: default !important;
        }
        
        .read-only-mode .option:hover {
            transform: none !important;
            box-shadow: none !important;
            border-color: #dee2e6 !important;
        }
        
        .read-only-mode .container {
            border: 3px solid #ffdac1;
        }
        
        .completed-badge {
            background: #ffdac1;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .completed-message {
            background: #d4edda;
            color: #155724;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            font-weight: 600;
            border: 2px solid #c3e6cb;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            .header {
                padding: 20px 15px;
            }
            .header h1 {
                font-size: 1.8rem;
            }
            .puzzle-content {
                padding: 20px;
            }
            .options {
                grid-template-columns: 1fr;
            }
            .option {
                padding: 20px 15px;
                font-size: 1.1rem;
            }
            .scramble-letters {
                flex-wrap: wrap;
                justify-content: center;
                gap: 10px;
            }
            .scramble-letter {
                width: 50px;
                height: 50px;
                font-size: 1.8rem;
            }
            .word-input input {
                width: 50px;
                height: 50px;
                font-size: 1.8rem;
            }
            .navigation {
                flex-direction: column;
                gap: 10px;
            }
            .nav-btn {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Database Status -->
        <div id="dbStatus" class="db-status">üîÑ Checking access...</div>

        <!-- Loading State -->
        <div id="loadingDay" class="loading">
            <div class="spinner"></div>
            <p>Loading Day 3...</p>
        </div>

        <!-- Main Content (hidden initially) -->
        <div id="dayContent" style="display: none;">
            <!-- Header -->
            <div class="header">
                <h1 id="dayTitle">Day 3: Deep Connections</h1>
                <div class="progress">Question <span id="currentPuzzle">1</span>/5</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-dots">
                    <div class="dot active">1</div>
                    <div class="dot">2</div>
                    <div class="dot">3</div>
                    <div class="dot">4</div>
                    <div class="dot">5</div>
                </div>
            </div>

            <!-- Navigation Bar -->
            <div class="nav-bar">
                <a href="dashboard.html" class="back-btn">‚Üê Back to Dashboard</a>
                <div id="dayIndicator" class="day-indicator">Day 3 of 7</div>
            </div>

            <!-- Puzzle Content -->
            <div class="puzzle-content">
                <!-- Completed Message (only shown in read-only mode) -->
                <div id="completedMessage" class="completed-message" style="display: none;">
                    You've already completed this day! Viewing in read-only mode. Proud of you!
                </div>

                <!-- Puzzle 1 -->
                <div id="puzzle1" class="puzzle active">
                    <h2>Enter the pass code üëÄ </h2>
                    <div class="hint-box">
                        üí° Hint: Call me and ask
                    </div>
                    <div class="text-input">
                        <input type="text" id="passCodeInput" placeholder="Enter pass code" maxlength="20">
                        <button id="checkPassCode">Submit</button>
                    </div>
                    <div id="nicknameMessage" class="nickname-message">
                        That's the nickname they gave me at home since I used to walk a lot and long distances going far away from home üòÇüòÇüò≠. WhatsApp me your nickname!üòí
                    </div>
                    <div id="feedback1" class="feedback"></div>
                </div>

                <!-- Puzzle 2 -->
                <div id="puzzle2" class="puzzle">
                    <h2>Unscramble the word!üò¨</h2>
                    <div class="hint-box">
                        üí° Hint: Idk üòè
                    </div>
                    <div class="scramble-letters">
                        <div class="scramble-letter">S</div>
                        <div class="scramble-letter">R</div>
                        <div class="scramble-letter">U</div>
                        <div class="scramble-letter">T</div>
                        <div class="scramble-letter">T</div>
                    </div>
                    <p class="hint">Enter the correct word below:</p>
                    <div class="word-input">
                        <input type="text" class="letter" maxlength="1" aria-label="Letter 1">
                        <input type="text" class="letter" maxlength="1" aria-label="Letter 2">
                        <input type="text" class="letter" maxlength="1" aria-label="Letter 3">
                        <input type="text" class="letter" maxlength="1" aria-label="Letter 4">
                        <input type="text" class="letter" maxlength="1" aria-label="Letter 5">
                    </div>
                    <button id="checkWord" class="check-btn">Check Word ü§î</button>
                    <p class="hint" style="margin-top: 30px;">In one sentence, why does this matter to us? (max 50 words)</p>
                    <textarea class="text-area" id="trustReason" placeholder="Share your thoughts here..." maxlength="300"></textarea>
                    <div id="feedback2" class="feedback"></div>
                </div>

                <!-- Puzzle 3 -->
                <div id="puzzle3" class="puzzle">
                    <h2>Logic Puzzle</h2>
                    <div class="hint-box">
                        üí° Idk üòè
                    </div>
                    <h3 style="text-align: center; margin: 30px 0; color: #333;">"If I text you 3 times in a row, and then call once, what am I probably feeling?"</h3>
                    <div class="options">
                        <button class="option" data-answer="Excited">Excited üòç</button>
                        <button class="option" data-answer="Sleepy">Sleepy üò¥</button>
                        <button class="option" data-answer="Hungry">Hungry üçï</button>
                        <button class="option" data-answer="Confused">Confused ü§î</button>
                    </div>
                    <div id="feedback3" class="feedback"></div>
                </div>

                <!-- Puzzle 4 -->
                <div id="puzzle4" class="puzzle">
                    <h2>Tell me something I don't know about you ü•∫ </h2>
                    <div class="hint-box">
                        üí° Share something personal or unique
                    </div>
                    <textarea class="text-area" id="unknownFact" placeholder="Write something about yourself that I might not know... (max 50 words)" maxlength="300"></textarea>
                    <button id="saveFact" class="check-btn" style="margin-top: 20px;">Save Answer</button>
                    <div id="feedback4" class="feedback"></div>
                </div>

                <!-- Puzzle 5 -->
                <div id="puzzle5" class="puzzle">
                    <h2>Boundary Question</h2>
                    <div class="hint-box">
                        üí° Be honest with your feelings
                    </div>
                    <h3 style="text-align: center; margin: 30px 0; color: #333;">"Did I break the boundary to touch you now?"</h3>
                    <div class="options">
                        <button class="option" data-answer="Yes">Yes ü´¶</button>
                        <button class="option" data-answer="No">No üò≠</button>
                    </div>
                    <p class="hint" style="margin-top: 30px;">Explain why or how (optional)</p>
                    <textarea class="text-area" id="boundaryReason" placeholder="Explain your answer... (optional)" maxlength="200"></textarea>
                    <div id="feedback5" class="feedback"></div>
                </div>

                <!-- Navigation -->
                <div class="navigation">
                    <button id="prevBtn" class="nav-btn prev-btn" disabled>‚Üê Previous</button>
                    <button id="nextBtn" class="nav-btn next-btn">Next Question ‚Üí</button>
                </div>

                <!-- Save Status -->
                <div id="saveStatus" class="save-status"></div>

                <!-- Complete Button -->
                <button id="completeBtn" class="complete-btn">Complete Day 3 ü•≥ü•≥</button>
            </div>

            <!-- Footer -->
            <div class="footer">
                <p>Made by Hlakulo (Your Daddy to be)</p>
            </div>
        </div>
    </div>

    <!-- Special Message Popup -->
    <div id="specialMessage" class="special-message">
        <div class="message-box">
            <h3 id="messageTitle">Special Message! üíï</h3>
            <p id="messageText"></p>
            <button id="closeMessage">Continue</button>
        </div>
    </div>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://yqxrsigblsalvhndfvvs.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlxeHJzaWdibHNhbHZobmRmdnZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNDUwNjQsImV4cCI6MjA4MDYyMTA2NH0.gsj4ya1LMKNtWGdwhaDa91L81AdOc6E1BcBd2gwXcJc';

        // Global variables
        let supabase;
        let currentUser = null;
        let currentDay = 3;
        let isReadOnly = false;

        // Correct answers
        const CORRECT_ANSWERS = {
            1: 'Johnny walker',
            2: 'TRUST',
            3: 'Excited',
            4: '', // No wrong answer
            5: '' // No wrong answer
        };

        // Main initialization - SESSIONSTORAGE ONLY
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Day 3: DOM loaded');

            // SIMPLE AUTHENTICATION CHECK - SESSIONSTORAGE ONLY
            await checkAuthentication();
        });

        // SIMPLIFIED AUTHENTICATION CHECK - SESSIONSTORAGE ONLY
        async function checkAuthentication() {
            console.log('Checking authentication...');

            // Check sessionStorage ONLY (will auto-clear when tab closes)
            const sessionData = sessionStorage.getItem('currentUser');

            if (sessionData) {
                try {
                    currentUser = JSON.parse(sessionData);
                    console.log('Found user in sessionStorage:', currentUser.username);

                    console.log('Authentication successful! User:', currentUser.username);

                    // Initialize Supabase
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

                    // Now check Day 3 access
                    await initializeDay();

                } catch (error) {
                    console.error('Error parsing sessionStorage:', error);
                    redirectToLogin();
                }
            } else {
                // No user found
                console.log('NO USER FOUND - Redirecting to login');
                redirectToLogin();
            }
        }

        function redirectToLogin() {
            showDBStatus('‚ùå Please login first!', 'error');
            setTimeout(() => {
                // Clear session data
                sessionStorage.clear();
                window.location.href = 'index.html';
            }, 1500);
        }

        async function initializeDay() {
            console.log('Initializing Day 3 for user:', currentUser.username);
            showDBStatus('üîê Checking Day 3 access...');

            try {
                // Check if Day 3 progress exists
                const {
                    data: progress,
                    error
                } = await supabase
                    .from('user_progress')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .eq('day_number', currentDay)
                    .single();

                if (error) {
                    // If no progress found, check if Day 2 is completed
                    if (error.code === 'PGRST116') {
                        console.log('No Day 3 progress found, checking Day 2 completion...');

                        const {
                            data: day2Progress
                        } = await supabase
                            .from('user_progress')
                            .select('completed')
                            .eq('user_id', currentUser.id)
                            .eq('day_number', 2)
                            .single();

                        if (!day2Progress || !day2Progress.completed) {
                            showDBStatus('‚ùå Complete Day 2 first!', 'error');
                            setTimeout(() => {
                                window.location.href = 'dashboard.html';
                            }, 2000);
                            return;
                        }

                        // Create Day 3 progress
                        await createDayProgress();
                    } else {
                        console.error('Error checking progress:', error);
                        throw error;
                    }
                } else {
                    console.log('Day 3 progress found:', progress);

                    if (!progress.unlocked_at && !progress.completed) {
                        showDBStatus('‚ùå Day 3 is locked', 'error');
                        setTimeout(() => {
                            window.location.href = 'dashboard.html';
                        }, 1500);
                        return;
                    }

                    if (progress.completed) {
                        console.log('Day 3 is completed - read-only mode');
                        isReadOnly = true;
                    }
                }

                console.log('Access granted! Read-only:', isReadOnly);
                showDBStatus('‚úÖ Access granted!', 'success');

                // Show content
                setTimeout(() => {
                    hideDBStatus();
                    document.getElementById('loadingDay').style.display = 'none';
                    document.getElementById('dayContent').style.display = 'block';
                    initializeQuiz();
                }, 1000);

            } catch (error) {
                console.error('Error initializing day:', error);
                showDBStatus('‚ùå Error: ' + error.message, 'error');
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 2000);
            }
        }

        async function createDayProgress() {
            const {
                error
            } = await supabase
                .from('user_progress')
                .insert([{
                    user_id: currentUser.id,
                    day_number: currentDay,
                    unlocked_at: new Date().toISOString(),
                    next_unlock_at: null,
                    completed: false,
                    progress: 0,
                    score: 0,
                    answers: {}
                }]);

            if (error) throw error;
        }

        function initializeQuiz() {
            console.log('Initializing Day 3 quiz...');

            // Quiz state
            let currentPuzzle = 1;
            const totalPuzzles = 5;
            const completedPuzzles = new Array(totalPuzzles).fill(false);
            let consecutiveCorrect = 0; // Keep track internally but don't show
            let wrongAttempts = {};

            // DOM Elements
            const currentPuzzleSpan = document.getElementById('currentPuzzle');
            const progressFill = document.getElementById('progressFill');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const completeBtn = document.getElementById('completeBtn');
            const dots = document.querySelectorAll('.dot');
            const specialMessage = document.getElementById('specialMessage');
            const messageText = document.getElementById('messageText');
            const messageTitle = document.getElementById('messageTitle');
            const closeMessage = document.getElementById('closeMessage');
            const completedMessage = document.getElementById('completedMessage');
            const nicknameMessage = document.getElementById('nicknameMessage');

            // Set up read-only mode if day is completed
            if (isReadOnly) {
                setupReadOnlyMode();
            }

            // Function to show specific puzzle
            function showPuzzle(num) {
                console.log('Showing puzzle', num);

                // Hide all puzzles
                for (let i = 1; i <= totalPuzzles; i++) {
                    const puzzle = document.getElementById(`puzzle${i}`);
                    if (puzzle) {
                        puzzle.classList.remove('active');
                    }
                }

                // Show current puzzle
                const currentPuzzleElement = document.getElementById(`puzzle${num}`);
                if (currentPuzzleElement) {
                    currentPuzzleElement.classList.add('active');
                    currentPuzzle = num;
                }

                // Update UI
                updateProgress();
                updateNavigation();
            }

            // Update progress display
            function updateProgress() {
                if (currentPuzzleSpan) currentPuzzleSpan.textContent = currentPuzzle;

                // Calculate progress percentage
                const completedCount = completedPuzzles.filter(c => c).length;
                const progressPercent = ((completedCount + (currentPuzzle - 1)) / totalPuzzles) * 100;
                if (progressFill) progressFill.style.width = `${progressPercent}%`;

                // Update dots
                dots.forEach((dot, index) => {
                    const puzzleNum = index + 1;
                    dot.classList.remove('active', 'completed');

                    if (puzzleNum === currentPuzzle) {
                        dot.classList.add('active');
                    } else if (completedPuzzles[puzzleNum - 1]) {
                        dot.classList.add('completed');
                    }
                });

                // Show/hide complete button
                const allCompleted = completedPuzzles.every(c => c);
                if (completeBtn && !isReadOnly) {
                    if (allCompleted) {
                        completeBtn.style.display = 'block';
                    } else {
                        completeBtn.style.display = 'none';
                    }
                }
            }

            // Update navigation buttons
            function updateNavigation() {
                if (prevBtn) prevBtn.disabled = currentPuzzle === 1;
                if (nextBtn) nextBtn.disabled = currentPuzzle === totalPuzzles;
            }

            // Setup all event listeners
            function setupEventListeners() {
                console.log('Setting up event listeners...');

                // Previous/Next buttons
                if (prevBtn) {
                    prevBtn.addEventListener('click', function() {
                        if (currentPuzzle > 1) {
                            showPuzzle(currentPuzzle - 1);
                        }
                    });
                }

                if (nextBtn) {
                    nextBtn.addEventListener('click', function() {
                        if (currentPuzzle < totalPuzzles) {
                            showPuzzle(currentPuzzle + 1);
                        }
                    });
                }

                // Complete button (only in active mode)
                if (completeBtn && !isReadOnly) {
                    completeBtn.addEventListener('click', function() {
                        showSpecialMessage("You're building something beautiful with me ‚ù§Ô∏è", true);
                    });
                }

                // Close message button
                if (closeMessage) {
                    closeMessage.addEventListener('click', function() {
                        specialMessage.style.display = 'none';

                        // If day is complete, redirect to dashboard
                        if (completedPuzzles.every(c => c) && !isReadOnly) {
                            completeDay();
                        }
                    });
                }

                // Load saved answers first
                loadSavedAnswers().then(savedAnswers => {
                    console.log('Loaded saved answers:', savedAnswers);
                    if (savedAnswers && savedAnswers.length > 0) {
                        restoreProgress(savedAnswers);
                        // Force update the progress display
                        updateProgress();
                    }

                    // Now setup each puzzle (only if not read-only)
                    if (!isReadOnly) {
                        setupPuzzle1();
                        setupPuzzle2();
                        setupPuzzle3();
                        setupPuzzle4();
                        setupPuzzle5();
                    }
                });
            }

            // Setup Puzzle 1 (Pass code)
            function setupPuzzle1() {
                const passCodeInput = document.getElementById('passCodeInput');
                const checkPassCode = document.getElementById('checkPassCode');

                if (!passCodeInput || !checkPassCode) {
                    console.error('Puzzle 1 elements not found');
                    return;
                }

                // Initialize wrong attempts counter
                if (!wrongAttempts[1]) {
                    wrongAttempts[1] = 0;
                }

                checkPassCode.addEventListener('click', async function() {
                    const userAnswer = passCodeInput.value.trim();
                    if (!userAnswer) {
                        showFeedback(1, false, 0);
                        return;
                    }

                    // Convert to lowercase for case-insensitive comparison
                    const userAnswerLower = userAnswer.toLowerCase();

                    // Allow multiple variations of the answer
                    const correctVariations = [
                        'johnny walker',
                        'johnnywalker',
                        'jonny walker', // Accept common typo
                        'jonnywalker'
                    ];

                    const isCorrect = correctVariations.includes(userAnswerLower);

                    if (isCorrect) {
                        // Correct answer
                        passCodeInput.classList.add('correct');
                        passCodeInput.classList.remove('wrong');
                        passCodeInput.disabled = true;
                        checkPassCode.disabled = true;
                        completedPuzzles[0] = true;

                        // Show nickname message
                        if (nicknameMessage) {
                            nicknameMessage.style.display = 'block';
                        }

                        // Update consecutive counter (internally only)
                        consecutiveCorrect++;

                        // Save answer to Supabase
                        await saveAnswerToSupabase(1, {
                            answer: userAnswer,
                            correct: true,
                            attempts: wrongAttempts[1] + 1
                        });

                        // Update progress
                        updateProgress();
                        showFeedback(1, true, 1);
                    } else {
                        // Wrong answer
                        passCodeInput.classList.add('wrong');
                        passCodeInput.classList.remove('correct');

                        // Reset consecutive counter
                        consecutiveCorrect = 0;

                        // Track wrong attempts
                        wrongAttempts[1] = (wrongAttempts[1] || 0) + 1;

                        // Show hint after 2 wrong attempts
                        if (wrongAttempts[1] === 2) {
                            showHint(1);
                        }

                        // Save attempt to Supabase
                        await saveAnswerToSupabase(1, {
                            answer: userAnswer,
                            correct: false,
                            attempts: wrongAttempts[1]
                        });

                        // Clear input after delay
                        setTimeout(() => {
                            passCodeInput.classList.remove('wrong');
                            passCodeInput.value = '';
                            passCodeInput.focus();
                        }, 1000);

                        showFeedback(1, false, wrongAttempts[1]);
                    }
                });

                // Enter key support
                passCodeInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        checkPassCode.click();
                    }
                });
            }

            // Setup Puzzle 2 (Word scramble)
            // Setup Puzzle 2 (Word scramble) - FIXED VERSION
            function setupPuzzle2() {
                const letterInputs = document.querySelectorAll('.letter');
                const checkWordBtn = document.getElementById('checkWord');
                const trustReason = document.getElementById('trustReason');

                if (!letterInputs.length || !checkWordBtn) {
                    console.error('Puzzle 2 elements not found');
                    return;
                }

                // Initialize wrong attempts counter
                if (!wrongAttempts[2]) {
                    wrongAttempts[2] = 0;
                }

                // Auto-focus between inputs
                letterInputs.forEach((input, index) => {
                    input.addEventListener('input', function(e) {
                        const value = this.value.toUpperCase();
                        this.value = value;

                        // Move to next input if letter entered
                        if (value.length === 1 && index < letterInputs.length - 1) {
                            letterInputs[index + 1].focus();
                        }

                        // Auto-submit if last letter is entered (optional)
                        if (index === letterInputs.length - 1 && value.length === 1) {
                            // Wait a bit then check
                            setTimeout(() => {
                                if (Array.from(letterInputs).every(input => input.value.length === 1)) {
                                    checkWordBtn.click();
                                }
                            }, 100);
                        }
                    });

                    // Arrow key navigation
                    input.addEventListener('keydown', function(e) {
                        if (e.key === 'ArrowLeft' && index > 0) {
                            letterInputs[index - 1].focus();
                        } else if (e.key === 'ArrowRight' && index < letterInputs.length - 1) {
                            letterInputs[index + 1].focus();
                        } else if (e.key === 'Backspace' && !this.value && index > 0) {
                            letterInputs[index - 1].focus();
                        } else if (e.key === 'Enter' && Array.from(letterInputs).every(input => input.value.length === 1)) {
                            checkWordBtn.click();
                        }
                    });
                });

                checkWordBtn.addEventListener('click', async function() {
                    // Get the word from inputs
                    const word = Array.from(letterInputs).map(input => input.value).join('').toUpperCase();

                    // Check if all letters are filled
                    if (word.length !== 5) {
                        showFeedback(2, false, 0);
                        // Highlight empty inputs
                        letterInputs.forEach(input => {
                            if (!input.value) {
                                input.classList.add('wrong');
                                setTimeout(() => input.classList.remove('wrong'), 1000);
                            }
                        });
                        return;
                    }

                    const isCorrect = word === CORRECT_ANSWERS[2];

                    if (isCorrect) {
                        // Correct answer
                        letterInputs.forEach(input => {
                            input.classList.add('correct');
                            input.classList.remove('wrong');
                            input.disabled = true;
                        });
                        checkWordBtn.disabled = true;
                        completedPuzzles[1] = true;

                        // Update consecutive counter (internally only)
                        consecutiveCorrect++;

                        // Save answer to Supabase
                        await saveAnswerToSupabase(2, {
                            answer: word,
                            correct: true,
                            attempts: wrongAttempts[2] + 1,
                            reason: trustReason ? trustReason.value : ''
                        });

                        // Update progress
                        updateProgress();
                        showFeedback(2, true, 1);
                    } else {
                        // Wrong answer
                        letterInputs.forEach(input => {
                            input.classList.add('wrong');
                            input.classList.remove('correct');
                        });

                        // Reset consecutive counter
                        consecutiveCorrect = 0;

                        // Track wrong attempts
                        wrongAttempts[2] = (wrongAttempts[2] || 0) + 1;

                        // Show hint after 2 wrong attempts
                        if (wrongAttempts[2] === 2) {
                            showHint(2);
                        }

                        // Save attempt to Supabase
                        await saveAnswerToSupabase(2, {
                            answer: word,
                            correct: false,
                            attempts: wrongAttempts[2]
                        });

                        // Clear inputs after delay
                        setTimeout(() => {
                            letterInputs.forEach(input => {
                                input.classList.remove('wrong');
                                input.value = '';
                            });
                            letterInputs[0].focus();
                        }, 1000);

                        showFeedback(2, false, wrongAttempts[2]);
                    }
                });

                // Save reason when typing
                if (trustReason) {
                    trustReason.addEventListener('input', function() {
                        // Auto-save reason to Supabase
                        saveAnswerReason(2, this.value);
                    });
                }
            }

            // Setup Puzzle 3 (Logic puzzle)
            function setupPuzzle3() {
                const options = document.querySelectorAll('#puzzle3 .option');

                if (!options.length) {
                    console.error('Puzzle 3 elements not found');
                    return;
                }

                // Initialize wrong attempts counter
                if (!wrongAttempts[3]) {
                    wrongAttempts[3] = 0;
                }

                options.forEach(option => {
                    option.addEventListener('click', async function() {
                        const userAnswer = this.dataset.answer;
                        const isCorrect = userAnswer === CORRECT_ANSWERS[3];

                        if (isCorrect) {
                            // Correct answer
                            this.classList.add('correct');
                            completedPuzzles[2] = true;
                            options.forEach(opt => opt.disabled = true);

                            // Update consecutive counter (internally only)
                            consecutiveCorrect++;

                            // Save answer to Supabase
                            await saveAnswerToSupabase(3, {
                                answer: userAnswer,
                                correct: true,
                                attempts: 1
                            });

                            // Update progress
                            updateProgress();
                            showFeedback(3, true, 1);
                        } else {
                            // Wrong answer
                            this.classList.add('wrong');
                            this.disabled = true;

                            // Reset consecutive counter
                            consecutiveCorrect = 0;

                            // Track wrong attempts
                            wrongAttempts[3] = (wrongAttempts[3] || 0) + 1;

                            // Show hint after 2 wrong attempts
                            if (wrongAttempts[3] === 2) {
                                showHint(3);
                            }

                            // Save attempt to Supabase
                            await saveAnswerToSupabase(3, {
                                answer: userAnswer,
                                correct: false,
                                attempts: 1
                            });

                            showFeedback(3, false, wrongAttempts[3]);
                        }
                    });
                });
            }

            // Setup Puzzle 4 (Tell me something)
            function setupPuzzle4() {
                const unknownFact = document.getElementById('unknownFact');
                const saveFact = document.getElementById('saveFact');

                if (!unknownFact || !saveFact) {
                    console.error('Puzzle 4 elements not found');
                    return;
                }

                saveFact.addEventListener('click', async function() {
                    const userAnswer = unknownFact.value.trim();
                    if (!userAnswer) {
                        showFeedback(4, false, 0);
                        return;
                    }

                    // Mark as completed (must have input)
                    unknownFact.disabled = true;
                    saveFact.disabled = true;
                    completedPuzzles[3] = true;

                    // Save answer to Supabase
                    await saveAnswerToSupabase(4, {
                        answer: userAnswer,
                        correct: true, // Always correct for this question
                        attempts: 1
                    });

                    // Update progress
                    updateProgress();
                    showFeedback(4, true, 1);
                });
            }

            // Setup Puzzle 5 (Boundary question)
            function setupPuzzle5() {
                const options = document.querySelectorAll('#puzzle5 .option');
                const boundaryReason = document.getElementById('boundaryReason');

                if (!options.length) {
                    console.error('Puzzle 5 elements not found');
                    return;
                }

                options.forEach(option => {
                    option.addEventListener('click', async function() {
                        const userAnswer = this.dataset.answer;

                        // Mark as completed (no wrong answer)
                        this.classList.add('correct');
                        completedPuzzles[4] = true;
                        options.forEach(opt => opt.disabled = true);

                        // Save answer to Supabase
                        await saveAnswerToSupabase(5, {
                            answer: userAnswer,
                            correct: true, // Always correct for this question
                            attempts: 1,
                            reason: boundaryReason ? boundaryReason.value : ''
                        });

                        // Update progress
                        updateProgress();
                        showFeedback(5, true, 1);
                    });
                });

                // Save reason when typing
                if (boundaryReason) {
                    boundaryReason.addEventListener('input', function() {
                        // Auto-save reason to Supabase
                        saveAnswerReason(5, this.value);
                    });
                }
            }

            // Show feedback message
            function showFeedback(puzzleNum, isCorrect, attempt) {
                const feedbackElement = document.getElementById(`feedback${puzzleNum}`);
                if (!feedbackElement) return;

                if (isCorrect && !isReadOnly) {
                    feedbackElement.textContent = "Good üôÇ‚Äç‚ÜïÔ∏è"; // Changed from "‚úÖ Correct! Well done!"
                    feedbackElement.className = 'feedback correct';
                    feedbackElement.style.display = 'block';

                    // Auto-hide after 2 seconds for active mode
                    setTimeout(() => {
                        feedbackElement.style.display = 'none';
                    }, 2000);
                } else if (!isCorrect && !isReadOnly) {
                    let message;
                    if (attempt === 1) {
                        message = "Zamani kambe he mhani ü•≤";
                    } else if (attempt === 2) {
                        message = "Ku ta lungha? üò≠";
                    } else {
                        message = "Ayaya Try again! üò¢";
                    }

                    feedbackElement.textContent = message;
                    feedbackElement.className = 'feedback incorrect';
                    feedbackElement.style.display = 'block';

                    // Auto-hide after 3 seconds
                    setTimeout(() => {
                        feedbackElement.style.display = 'none';
                    }, 3000);
                }
                // In read-only mode, don't show any feedback messages
            }

            // Show special message popup
            function showSpecialMessage(message, isDayComplete = false) {
                if (!messageText || !messageTitle) return;

                messageText.textContent = message;
                messageTitle.textContent = isDayComplete ? "Day 3 Complete! ü•≥ü•≥" : "Special Message! ü•∫";
                if (specialMessage) {
                    specialMessage.style.display = 'flex';
                }

                // If day is complete, update button text
                if (isDayComplete && closeMessage) {
                    closeMessage.textContent = "Go to Dashboard";
                }
            }

            // Show hint after 2 wrong attempts
            function showHint(puzzleNum) {
                const hints = {
                    1: "Hint: It's a nickname related to 'walking'",
                    2: "Hint: It's a 5-letter word about reliability",
                    3: "Hint: Think about 'excited' behavior patterns üëÄ",
                    5: "Hint: Be honest about your comfort level ü•π"
                };

                const hint = hints[puzzleNum];
                if (hint) {
                    const feedbackElement = document.getElementById(`feedback${puzzleNum}`);
                    if (feedbackElement && !isReadOnly) {
                        feedbackElement.textContent = `üí° ${hint}`;
                        feedbackElement.className = 'feedback incorrect';
                        feedbackElement.style.display = 'block';

                        // Auto-hide after 5 seconds
                        setTimeout(() => {
                            feedbackElement.style.display = 'none';
                        }, 5000);
                    }
                }
            }

            // Save answer to Supabase
            async function saveAnswerToSupabase(puzzleNumber, answerData) {
                try {
                    const {
                        error
                    } = await supabase
                        .from('day_answers')
                        .upsert({
                            user_id: currentUser.id,
                            day_number: currentDay,
                            puzzle_number: puzzleNumber,
                            answer: answerData.answer,
                            correct: answerData.correct,
                            attempts: answerData.attempts,
                            reason: answerData.reason || null,
                            answered_at: new Date().toISOString()
                        }, {
                            onConflict: 'user_id,day_number,puzzle_number'
                        });

                    if (error) throw error;

                    // Update progress in Supabase
                    await updateProgressInSupabase();

                    showSaveStatus('‚úÖ Answer saved!');

                } catch (error) {
                    console.error('Error saving answer:', error);
                    showSaveStatus('‚ùå Failed to save', 'error');
                }
            }

            // Save answer reason separately
            async function saveAnswerReason(puzzleNumber, reason) {
                try {
                    const {
                        error
                    } = await supabase
                        .from('day_answers')
                        .update({
                            reason: reason
                        })
                        .eq('user_id', currentUser.id)
                        .eq('day_number', currentDay)
                        .eq('puzzle_number', puzzleNumber);

                    if (error) throw error;
                } catch (error) {
                    console.error('Error saving reason:', error);
                }
            }

            // Update progress in Supabase
            async function updateProgressInSupabase() {
                try {
                    // Count completed puzzles
                    const {
                        data: answers,
                        error: answersError
                    } = await supabase
                        .from('day_answers')
                        .select('correct')
                        .eq('user_id', currentUser.id)
                        .eq('day_number', currentDay);

                    if (answersError) throw answersError;

                    const completedCount = answers.filter(a => a.correct).length;
                    const isComplete = completedCount === 5;

                    // Update progress
                    const {
                        error: progressError
                    } = await supabase
                        .from('user_progress')
                        .update({
                            progress: completedCount,
                            completed: isComplete,
                            score: completedCount * 20,
                            completed_at: isComplete ? new Date().toISOString() : null
                        })
                        .eq('user_id', currentUser.id)
                        .eq('day_number', currentDay);

                    if (progressError) throw progressError;

                    if (isComplete && !isReadOnly) {
                        // Start countdown for next day
                        await startNextDayCountdown();
                    }

                } catch (error) {
                    console.error('Error updating progress:', error);
                }
            }

            // Start countdown for next day
            async function startNextDayCountdown() {
                try {
                    const nextDay = currentDay + 1;
                    if (nextDay > 7) return;

                    // 24 hours for Jessica (girlfriend), 3 minutes for Hlakulo (test)
                    const isJessica = currentUser.is_jessica;
                    const unlockDuration = isJessica ? 24 * 60 * 60 * 1000 : 3 * 60 * 1000;
                    const nextUnlockAt = new Date(Date.now() + unlockDuration).toISOString();

                    console.log(`Countdown for Day ${nextDay}: ${isJessica ? '24 hours (Jessica real)' : '3 minutes (Hlakulo test)'}`);

                    // Create or update next day progress
                    const {
                        error
                    } = await supabase
                        .from('user_progress')
                        .upsert({
                            user_id: currentUser.id,
                            day_number: nextDay,
                            next_unlock_at: nextUnlockAt,
                            unlocked_at: null,
                            completed: false,
                            progress: 0,
                            score: 0
                        }, {
                            onConflict: 'user_id,day_number'
                        });

                    if (error) throw error;

                } catch (error) {
                    console.error('Error starting countdown:', error);
                }
            }

            // Load saved answers from Supabase
            async function loadSavedAnswers() {
                try {
                    const {
                        data: answers,
                        error
                    } = await supabase
                        .from('day_answers')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .eq('day_number', currentDay)
                        .order('puzzle_number', {
                            ascending: true
                        });

                    if (error) throw error;

                    return answers || [];

                } catch (error) {
                    console.error('Error loading saved answers:', error);
                    return [];
                }
            }

            // Restore progress from saved answers
            function restoreProgress(savedAnswers) {
                console.log('Restoring progress from:', savedAnswers);

                if (!savedAnswers || savedAnswers.length === 0) {
                    console.log('No saved answers found');
                    return;
                }

                // Mark all puzzles as completed by default in read-only mode
                if (isReadOnly) {
                    for (let i = 0; i < totalPuzzles; i++) {
                        completedPuzzles[i] = true;
                    }
                }

                savedAnswers.forEach(answer => {
                    const puzzleNum = answer.puzzle_number;

                    if (answer.correct) {
                        completedPuzzles[puzzleNum - 1] = true;

                        // Restore puzzle 1 (pass code)
                        if (puzzleNum === 1) {
                            const passCodeInput = document.getElementById('passCodeInput');
                            const checkPassCode = document.getElementById('checkPassCode');
                            if (passCodeInput) {
                                passCodeInput.value = answer.answer;
                                passCodeInput.classList.add('correct');
                                passCodeInput.disabled = true;
                            }
                            if (checkPassCode) checkPassCode.disabled = true;
                            if (nicknameMessage) nicknameMessage.style.display = 'block';
                        }
                        // Restore puzzle 2 (word scramble)
                        else if (puzzleNum === 2) {
                            const letterInputs = document.querySelectorAll('.letter');
                            const checkWordBtn = document.getElementById('checkWord');
                            const trustReason = document.getElementById('trustReason');
                            const word = answer.answer || '';
                            for (let i = 0; i < Math.min(word.length, letterInputs.length); i++) {
                                letterInputs[i].value = word[i];
                                letterInputs[i].classList.add('correct');
                                letterInputs[i].disabled = true;
                            }
                            if (checkWordBtn) checkWordBtn.disabled = true;
                            if (trustReason && answer.reason) {
                                trustReason.value = answer.reason;
                                if (isReadOnly) trustReason.disabled = true;
                            }
                        }
                        // Restore puzzle 3 (logic puzzle)
                        else if (puzzleNum === 3) {
                            const options = document.querySelectorAll('#puzzle3 .option');
                            options.forEach(option => {
                                option.disabled = true;
                                if (option.dataset.answer === answer.answer) {
                                    option.classList.add('correct');
                                }
                            });
                        }
                        // Restore puzzle 4 (tell me something)
                        else if (puzzleNum === 4) {
                            const unknownFact = document.getElementById('unknownFact');
                            const saveFact = document.getElementById('saveFact');
                            if (unknownFact) {
                                unknownFact.value = answer.answer;
                                unknownFact.disabled = true;
                            }
                            if (saveFact) saveFact.disabled = true;
                        }
                        // Restore puzzle 5 (boundary question)
                        else if (puzzleNum === 5) {
                            const options = document.querySelectorAll('#puzzle5 .option');
                            const boundaryReason = document.getElementById('boundaryReason');
                            options.forEach(option => {
                                option.disabled = true;
                                if (option.dataset.answer === answer.answer) {
                                    option.classList.add('correct');
                                }
                            });
                            if (boundaryReason && answer.reason) {
                                boundaryReason.value = answer.reason;
                                if (isReadOnly) boundaryReason.disabled = true;
                            }
                        }

                        // Don't show feedback in read-only mode
                        if (!isReadOnly) {
                            const feedbackElement = document.getElementById(`feedback${puzzleNum}`);
                            if (feedbackElement) {
                                feedbackElement.textContent = "Good";
                                feedbackElement.className = 'feedback correct';
                                feedbackElement.style.display = 'block';

                                // Hide after 2 seconds in active mode
                                setTimeout(() => {
                                    feedbackElement.style.display = 'none';
                                }, 2000);
                            }
                        }
                    } else {
                        // For wrong answers in read-only mode, still show the attempt
                        if (isReadOnly) {
                            if (puzzleNum === 1 || puzzleNum === 3) {
                                const options = document.querySelectorAll(`#puzzle${puzzleNum} .option`);
                                options.forEach(option => {
                                    option.disabled = true;
                                    if (option.dataset.answer === answer.answer) {
                                        option.classList.add('wrong');
                                    }
                                });
                            } else if (puzzleNum === 2) {
                                const letterInputs = document.querySelectorAll('.letter');
                                letterInputs.forEach(input => {
                                    input.disabled = true;
                                });
                            }
                        }
                    }
                });

                console.log('Completed puzzles after restore:', completedPuzzles);
            }

            // Complete the day
            async function completeDay() {
                try {
                    // Mark day as complete in Supabase
                    const {
                        error
                    } = await supabase
                        .from('user_progress')
                        .update({
                            completed: true,
                            completed_at: new Date().toISOString()
                        })
                        .eq('user_id', currentUser.id)
                        .eq('day_number', currentDay);

                    if (error) throw error;

                    // Redirect to dashboard after delay
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 500);

                } catch (error) {
                    console.error('Error completing day:', error);
                }
            }

            // Show save status
            function showSaveStatus(message, type = 'success') {
                const status = document.getElementById('saveStatus');
                if (status) {
                    status.textContent = message;
                    status.style.color = type === 'success' ? '#28a745' : '#dc3545';
                    status.style.display = 'block';

                    setTimeout(() => {
                        status.style.display = 'none';
                    }, 3000);
                }
            }

            // Function to set up read-only mode
            function setupReadOnlyMode() {
                console.log('Setting up read-only mode...');

                // Update header
                const dayTitle = document.getElementById('dayTitle');
                if (dayTitle) {
                    dayTitle.innerHTML = 'Day 3: Completed ‚úÖ <span class="completed-badge">READ ONLY</span>';
                }

                // Update day indicator
                const dayIndicator = document.getElementById('dayIndicator');
                if (dayIndicator) {
                    dayIndicator.textContent = 'Day 3 of 7 (Completed)';
                }

                // Show completed message
                if (completedMessage) {
                    completedMessage.style.display = 'block';
                }

                // Hide complete button
                if (completeBtn) {
                    completeBtn.style.display = 'none';
                }

                // Add read-only class to body
                document.body.classList.add('read-only-mode');

                // Disable all interactive elements except navigation buttons
                const allOptions = document.querySelectorAll('.option');
                allOptions.forEach(option => {
                    option.disabled = true;
                    option.style.cursor = 'default';
                });

                const allInputs = document.querySelectorAll('input, textarea, button:not(.back-btn):not(.nav-btn)');
                allInputs.forEach(input => {
                    input.disabled = true;
                });

                // Load and display saved answers immediately
                loadSavedAnswers().then(savedAnswers => {
                    console.log('Loading answers for read-only mode:', savedAnswers);
                    if (savedAnswers && savedAnswers.length > 0) {
                        restoreProgress(savedAnswers);
                        // Force update the progress display
                        updateProgress();
                    } else {
                        console.log('No saved answers found for read-only mode');
                    }
                });
            }

            // Initialize the quiz
            showPuzzle(1);
            setupEventListeners();
        }

        function showDBStatus(message, type = '') {
            const statusBar = document.getElementById('dbStatus');
            if (statusBar) {
                statusBar.textContent = message;
                statusBar.className = `db-status ${type}`;
                statusBar.style.display = 'block';
            }
        }

        function hideDBStatus() {
            const statusBar = document.getElementById('dbStatus');
            if (statusBar) {
                statusBar.style.display = 'none';
            }
        }
    </script>
</body>

</html>